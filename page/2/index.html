<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Lao Yuan&#39;s Personal Website">
<meta property="og:url" content="http://gityuanye.cn/page/2/index.html">
<meta property="og:site_name" content="Lao Yuan&#39;s Personal Website">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lao Yuan&#39;s Personal Website">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://gityuanye.cn/page/2/"/>





  <title>Lao Yuan's Personal Website</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lao Yuan's Personal Website</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">LaoYuan</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/09/24/php中mysql数据库异步查询实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/php中mysql数据库异步查询实现/" itemprop="url">php中mysql数据库异步查询实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-24T16:43:00+08:00">
                2016-09-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p>通常一个web应用的性能瓶颈在数据库。因为，通常情况下php中mysql查询是串行的。也就是说，如果指定两条sql语句时，第二条sql语句会等到第一条sql语句执行完毕再去执行。这个时候，如果执行2条sql语句，每条执行时间为50ms，全部执行完毕可能需要100ms。既然，主要原因是sql的串行执行导致。那我们是不是可以改变执行方式来提高性能呢？答案是，可以的。我们可以通过异步执行的方式来提高性能。</p>
<h5 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h5><p>如果通过异步的方式去执行，可能性能会有很大提升。如果是采用异步的方式，两条sql语句会并发执行，可能就需要60ms就可以执行完毕。</p>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><p>mysqli + mysqlnd。php官方实现的mysqlnd中提供了异步查询的方法。分别是：<br>mysqlnd_async_query 发送查询请求<br>mysqlnd_reap_async_query 获取查询结果<br>这样就可以不必每次发送完查询请求后，一直阻塞等待查询结果了。</p>
<p>实现代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  </span><br><span class="line">$host       = &apos;127.0.0.1&apos;;</span><br><span class="line">$user       = &apos;root&apos;;</span><br><span class="line">$password   = &apos;&apos;;</span><br><span class="line">$database   = &apos;test&apos;;</span><br><span class="line">  </span><br><span class="line">/**</span><br><span class="line"> * 期望得到额结果</span><br><span class="line"> * array(</span><br><span class="line"> *  1 =&gt; int,</span><br><span class="line"> *  2 =&gt; int,</span><br><span class="line"> *  3 =&gt; int</span><br><span class="line"> * )</span><br><span class="line"> */</span><br><span class="line">$result = array(1=&gt;0, 2=&gt;0, 3=&gt;0);</span><br><span class="line">  </span><br><span class="line">//异步方式[并发请求]</span><br><span class="line">$time_start = microtime(true);</span><br><span class="line">$links = array();</span><br><span class="line">  </span><br><span class="line">foreach ($result as $key=&gt;$value) &#123;</span><br><span class="line">    $obj = new mysqli($host, $user, $password, $database);</span><br><span class="line">    $links[spl_object_hash($obj)] = array(&apos;value&apos;=&gt;$key, &apos;link&apos;=&gt;$obj);</span><br><span class="line">&#125;</span><br><span class="line">$done = 0;</span><br><span class="line">$total = count($links);</span><br><span class="line">  </span><br><span class="line">foreach ($links as $value) &#123;</span><br><span class="line">    $value[&apos;link&apos;]-&gt;query(&quot;SELECT COUNT(*) AS `total` FROM `demo` WHERE `value`=&#123;$value[&apos;value&apos;]&#125;&quot;, MYSQLI_ASYNC);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">do &#123;</span><br><span class="line">  </span><br><span class="line">    $tmp = array();</span><br><span class="line">    foreach ($links as $value) &#123;</span><br><span class="line">        $tmp[] = $value[&apos;link&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    $read = $errors = $reject = $tmp;</span><br><span class="line">    $re = mysqli_poll($read, $errors, $reject, 1);</span><br><span class="line">    if (false === $re) &#123;</span><br><span class="line">        die(&apos;mysqli_poll failed&apos;);</span><br><span class="line">    &#125; elseif ($re &lt; 1) &#123;</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    foreach ($read as $link) &#123;</span><br><span class="line">        $sql_result = $link-&gt;reap_async_query();</span><br><span class="line">        if (is_object($sql_result)) &#123;</span><br><span class="line">            $sql_result_array = $sql_result-&gt;fetch_array(MYSQLI_ASSOC);//只有一行</span><br><span class="line">            $sql_result-&gt;free();</span><br><span class="line">            $hash = spl_object_hash($link);</span><br><span class="line">            $key_in_result = $links[$hash][&apos;value&apos;];</span><br><span class="line">            $result[$key_in_result] = $sql_result_array[&apos;total&apos;];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo $link-&gt;error, &quot;\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        $done++;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    foreach ($errors as $link) &#123;</span><br><span class="line">        echo $link-&gt;error, &quot;1\n&quot;;</span><br><span class="line">        $done++;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    foreach ($reject as $link) &#123;</span><br><span class="line">        printf(&quot;server is busy, client was rejected.\n&quot;, $link-&gt;connect_error, $link-&gt;error);</span><br><span class="line">        //这个地方别再$done++了。</span><br><span class="line">    &#125;</span><br><span class="line">&#125; while ($done&lt;$total);</span><br><span class="line">var_dump($result);</span><br><span class="line">echo &quot;ASYNC_QUERY_TIME:&quot;, microtime(true)-$time_start, &quot;\n&quot;;</span><br><span class="line">  </span><br><span class="line">$link = end($links);</span><br><span class="line">$link = $link[&apos;link&apos;];</span><br><span class="line">echo &quot;\n&quot;;</span><br></pre></td></tr></table></figure>
<h5 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h5><p>mysql数据库对于每个查询请求都是单独启动一个线程进行处理。如果mysql服务器启动线程过多，必然会造成线程切换引起系统负载过高。如果在mysql数据库负载不高的情况下，使用异步查询还是不错的选择。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/09/05/一次错误的排查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/05/一次错误的排查/" itemprop="url">一次错误的排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-05T20:00:00+08:00">
                2016-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近给XX项目搭建一个反垃圾平台。效果不错，但是出现了一个诡异的事情。离线扫描部分会有一个常驻的php进程，以便处理发现的垃圾信息。常驻的php进程总是诡异的退出。php代码示例如下：</p>
<h5 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h5><p>最初的想法是php执行过程中出现的致命错误，导致php进程退出。好吧，我们使用register_shutdown_function来跟踪下到底是什么错误导致的进程退出。（想更多了解register_shutdown_function，请查看博文 <a href="http://www.bo56.com/%E5%A6%99%E7%94%A8php%E4%B8%AD%E7%9A%84register_shutdown_function%E5%92%8Cfastcgi_finish_request/" target="_blank" rel="noopener">妙用php中的register_shutdown_function和fastcgi_finish_request</a>）加入了错误捕捉代码。如下：</p>
<p>可是，php进程再次退出。而在日志中并没有记录任何信息。说明register_shutdown_function方法根本没有执行。是什么导致register_shutdown_function方法没有运行呢？在php的官方文档中又这样一个注释：</p>
<blockquote>
<p>Shutdown functions will not be executed if the process is killed with a SIGTERM or SIGKILL signal. While you cannot intercept a SIGKILL, you can use <a href="http://php.net/manual/zh/function.pcntl-signal.php" target="_blank" rel="noopener">pcntl_signal()</a> to install a handler for a SIGTERM which uses <a href="http://php.net/manual/zh/function.exit.php" target="_blank" rel="noopener">exit()</a> to end cleanly.</p>
</blockquote>
<p>注释的意思是当php进程获得SIGTERM和SIGKILL信号而退出时，是不执行register_shutdown_function方法的。可以使用pcntl_signal()方法来捕获信息，并调用相应的处理方法。</p>
<p>好，那是不是信号导致我们的php进程退出呢？我们加入如下代码：</p>
<p>过一段时间，发现php进程退出了，日志中出现了如下日志信息：<br>2014-11-23 18:30:06 exit signo[14]<br>2014-11-23 18:30:06 [error]is_end[no]</p>
<p>看来是sigalarm信号导致php进程退出了。这个信号是可以捕获和处理的。这样无关紧要的信号，我们还是忽略吧。最终的代码如下：</p>
<p>经过一段观察，在日志中又发现了alarm相关的日志，但是php进程依然在。看来我们的修改有作用了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/08/25/mysqlnd cannot connect to MySQL 4.1+ using the old insecure authentication解决办法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/25/mysqlnd cannot connect to MySQL 4.1+ using the old insecure authentication解决办法/" itemprop="url">mysqlnd cannot connect to MySQL 4.1+ using the old insecure authentication解决办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-25T20:00:00+08:00">
                2016-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mysqlnd是个好东西。不仅可以提高与mysql数据库通信的效率，而且也可以方便的设置一些超时。如，连接超时，查询超时。<br>但是，使用mysqlnd的时候，有个地方需要注意。就是服务端的密码格式不能使用旧的16位的存储格式，而要使用新的41位的存储格式。<br>如果，服务端的密码格式是16位，那么就会报错。信息如下：<br>Fatal error: Uncaught exception ‘PDOException’ with message ‘SQLSTATE[HY000] [2000] mysqlnd cannot connect to MySQL 4.1+ using the old insecure authentication. Please use an administration tool to reset your password with the command SET PASSWORD = PASSWORD(‘your_existing_password’). This will store a new, and more secure, hash value in mysql.user. If this user is used in other scripts executed by PHP 5.2 or earlier you might need to remove the old-passwords flag from your my.cnf file’ in /home/hailong.xhl/test.php:8</p>
<p>如何查看自己的密码是否符合要求，so easy。</p>
<p>上面的密码是旧的16位格式。如果想改成新的41位格式，通过以下命令就可以。</p>
<p>修改完密码后，还需要在配置文件中修改下old_passwords选项。把值设置为0。即，<br>old_passwords=0<br>然后重启mysql。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/08/13/动态修改php的配置项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/13/动态修改php的配置项/" itemprop="url">动态修改php的配置项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-13T14:00:00+08:00">
                2016-08-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们一般修改php的配置项都是在php.ini中修改。在php,ini中的修改会影响到所有使用php的程序。假如我想让修改只在某个域名下生效，该如何做呢?</p>
<p><strong>使用ini_set()</strong><br>首先想到的可能是使用ini_set()方法在脚本中修改。但是这个只能修改作用域为PHP_INI_USER和PHP_INI_ALL的配置项。具体配置项作用域说明请查看 <a href="http://www.bo56.com/php%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4%E4%BD%9C%E7%94%A8%E5%9F%9F%E8%AF%B4%E6%98%8E/" target="_blank" rel="noopener">PHP配置指令作用域说明</a></p>
<p><strong>使用php_value</strong><br>如果我访问url时，程序每次执行都自动加载一个header.php文件。但是，如果是通过shell脚本方式执行，就不要加载这个文件了。要实现这个需求，我们需要用到 auto_prepend_file 这个配置想。这个配置想的作用域是 PHP_INI_PERDIR 。 也就是说不能通过ini_set()方法设置。那我们可以通过php_value进行设置。</p>
<p>如果是apache+php的组合，我们可以在apache的配置文件中加入如下指令即可。</p>
<blockquote>
<p>Php_value auto_prepend_file /home/www/bo56.com/header.php</p>
</blockquote>
<p>如果是nginx+php组合，可以加入如下指令</p>
<blockquote>
<p>fastcgi_param PHP_VALUE “auto_prepend_file=/home/www/bo56.com/header.php”;</p>
</blockquote>
<p>注意，nginx中多次使用 PHP_VALUE时，最后的一个会覆盖之前的。如果想设置多个配置项，需要写在一起，然后用换行分割。如：</p>
<blockquote>
<p>fastcgi_param PHP_VALUE “auto_prepend_file=/home/www/bo56.com/header.php \n auto_append_file=/home/www/bo56.com/external/footer.php”;</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/07/26/php中如何设置mysql查询读取数据的超时时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/26/php中如何设置mysql查询读取数据的超时时间/" itemprop="url">php中如何设置mysql查询读取数据的超时时间</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-26T14:00:00+08:00">
                2016-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现象：<br>php能通过代理正常连接到mysql。但是，执行query后，一直等待，没有任何数据返回。<br>结果导致php-fpm进程全部阻塞在读取数据的地方。不能处理其他正常请求。</p>
<p>解决方法：<br>可以通过设置mysql查杀的超时时间来解决这个问题。<br>第一种设置mysql查询超时时间的方法是使用mysqlnd。<br>关于msyqlnd的介绍，大家可以看下这篇文章 <a href="http://www.bo56.com/php-mysqlnd-%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">http://www.bo56.com/php-mysqlnd-简介/</a><br>php启用mysqlnd扩展后，只要在php.ini文件中设置 mysqlnd.net_read_timeout 即可。<br>参数值的单位为秒。如：<br>mysqlnd.net_read_timeout = 3 表示每次mysql查询超时时间为3秒。如果超时，则会报错。<br>如下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$dsn = &apos;mysql:dbname=demo;host=127.0.0.1;port=3306&apos;;</span><br><span class="line">$user = &apos;demo&apos;;</span><br><span class="line">$password = &apos;demo&apos;;</span><br><span class="line">$dbh = new PDO($dsn, $user, $password);</span><br><span class="line">$dbh-&gt;query(&quot;set names utf8&quot;);</span><br><span class="line">$sql = &quot;select sleep(5)&quot;;</span><br><span class="line">$sth = $dbh-&gt;query($sql);</span><br><span class="line">$row = $sth-&gt;fetch();</span><br><span class="line">echo &quot;over&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>则会报错误：<br>PHP Warning: PDO::query(): MySQL server has gone away<br>PHP Warning: PDO::query(): Error reading result set’s header<br>PHP Fatal error: Call to a member function fetch() on a non-object<br>由于出现了PHP Fatal error错误，导致fetch()之后的代码将无法执行。<br>因此代码需要对query的返回值做下判断，修改后的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$dsn = &apos;mysql:dbname=demo;host=127.0.0.1;port=3306&apos;;</span><br><span class="line">$user = &apos;demo&apos;;</span><br><span class="line">$password = &apos;demo&apos;;</span><br><span class="line">$dbh = new PDO($dsn, $user, $password);</span><br><span class="line">$dbh-&gt;query(&quot;set names utf8&quot;);</span><br><span class="line">$sql = &quot;select sleep(5)&quot;;</span><br><span class="line">$sth = $dbh-&gt;query($sql);</span><br><span class="line">if(is_object($sth))&#123;</span><br><span class="line">    $row = $sth-&gt;fetch();</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;over&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意：设置项 mysqlnd.net_read_timeout 的级别是PHP_INI_SYSTEM。所以在php代码中不能修改mysql查询的超时时间。</p>
<p>另一种方式是使用mysqli。<br>如果php没有启用mysqlnd，那么可以使用mysqli进行限制read的超时时间。<br>示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//自己定义读写超时常量</span><br><span class="line">if (!defined(&apos;MYSQL_OPT_READ_TIMEOUT&apos;)) &#123;</span><br><span class="line">        define(&apos;MYSQL_OPT_READ_TIMEOUT&apos;,  11);</span><br><span class="line">&#125;</span><br><span class="line">if (!defined(&apos;MYSQL_OPT_WRITE_TIMEOUT&apos;)) &#123;</span><br><span class="line">        define(&apos;MYSQL_OPT_WRITE_TIMEOUT&apos;, 12);</span><br><span class="line">&#125;</span><br><span class="line">//设置超时</span><br><span class="line">$mysqli = mysqli_init();</span><br><span class="line">$mysqli-&gt;options(MYSQL_OPT_READ_TIMEOUT, 3);</span><br><span class="line">$mysqli-&gt;options(MYSQL_OPT_WRITE_TIMEOUT, 1);</span><br><span class="line">//连接数据库</span><br><span class="line">$mysqli-&gt;real_connect(&quot;localhost&quot;, &quot;root&quot;, &quot;root&quot;, &quot;test&quot;);</span><br><span class="line">if (mysqli_connect_errno()) &#123;</span><br><span class="line">   printf(&quot;Connect failed: %s/n&quot;, mysqli_connect_error());</span><br><span class="line">   exit();</span><br><span class="line">&#125;</span><br><span class="line">//执行查询 sleep 1秒不超时</span><br><span class="line">printf(&quot;Host information: %s/n&quot;, $mysqli-&gt;host_info);</span><br><span class="line">if (!($res=$mysqli-&gt;query(&apos;select sleep(1)&apos;))) &#123;</span><br><span class="line">    echo &quot;query1 error: &quot;. $mysqli-&gt;error .&quot;/n&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;Query1: query success/n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">//执行查询 sleep 9秒会超时</span><br><span class="line">if (!($res=$mysqli-&gt;query(&apos;select sleep(9)&apos;))) &#123;</span><br><span class="line">    echo &quot;query2 error: &quot;. $mysqli-&gt;error .&quot;/n&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;Query2: query success/n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$mysqli-&gt;close();</span><br><span class="line">echo &quot;close mysql connection/n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>超时设置单位为秒，最少配置1秒</li>
<li>但mysql底层的read会重试两次，所以实际会是 3 秒</li>
</ol>
<p>重试两次 + 自身一次 = 3倍超时时间。<br>那么就是说最少超时时间是3秒，不会低于这个值，对于大部分应用来说可以接受，但是对于小部分应用需要优化。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/07/16/php-fpm的慢执行日志slow log，分析php性能问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/16/php-fpm的慢执行日志slow log，分析php性能问题/" itemprop="url">php-fpm的慢执行日志slow log，分析php性能问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-16T14:00:00+08:00">
                2016-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，mysql有slow query log，根据慢查询日志，我们可以知道那些sql语句有性能问题。作为mysql的好搭档，php也有这样的功能。如果你使用php-fpm来管理php的话，你可以通过如下选项开启。<br>PHP 5.3.3 之前设置如下：</p>
<p>5s</p>
<p>logs/php-fpm-slowlog.log</p>
<p>PHP 5.3.3 之后设置以下如下：<br>request_slowlog_timeout = 5s<br>slowlog = /usr/local/php/log/php-fpm-slowlog.log</p>
<p>说明：<br>request_slowlog_timeout 是脚本超过多长时间 就可以记录到日志文件<br>slowlog 是日志文件的路径</p>
<p>开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息：</p>
<blockquote>
<p>[13-Mar-2015 16:54:49][pool www] pid 18575<br>script_filename = /home/web/htdocs/sandbox_canglong/test/tt.php<br>[0x0000000003a00dc8] curl_exec() /home/web/htdocs/sandbox_canglong/test/tt.php:2<br>[0x0000000003a00cd0] exfilter_curl_get() /home/web/htdocs/sandbox_canglong/test/tt.php:6</p>
</blockquote>
<p>日志说明：<br>script_filename 是入口文件<br>curl_exec() ： 说明是执行这个方法的时候超过执行时间的。<br>exfilter_curl_get() ：说明调用curl_exec()的方法是exfilter_curl_get() 。<br>每行冒号后面的数字是行号。</p>
<p>开启后，在错误日志文件中也有相关记录。如下：</p>
<blockquote>
<p>[13-Mar-2015 15:55:37] WARNING: [pool www] child 18575, script ‘/home/web/htdocs/sandbox_canglong/test/tt.php’ (request: “GET /test/tt.php”) executing too slow (1.006222 sec), logging<br>[13-Mar-2015 15:55:37] NOTICE: child 18575 stopped for tracing<br>[13-Mar-2015 15:55:37] NOTICE: about to trace 18575<br>[13-Mar-2015 15:55:37] NOTICE: finished trace of 18575</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/07/02/一个echo引起的进程崩溃/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/02/一个echo引起的进程崩溃/" itemprop="url">一个echo引起的进程崩溃</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-02T16:00:00+08:00">
                2016-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在编写后台程序时遇到一个问题。发现后台程序总是莫名其妙的die掉。经排查，发现罪魁祸首是一个echo。<br><strong>案情重现：</strong><br>1.ssh登陆服务器<br>2.新建一个php文件test.php，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">sleep(50);</span><br><span class="line">echo &quot;aaa\n&quot;;</span><br><span class="line">file_put_contents(&quot;/tmp/test.txt&quot;,time());</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>3.用以下命令执行test.php程序<br>$ php test.php &amp;<br>查看 /tmp/test.txt 文件的内容为 1381325659<br>4.然后再次执行如下命令。命令执行后，马上使用exit命令退出登陆<br>$ php test.php &amp;<br>5.然后ssh登陆服务器，发现/tmp/test.txt 文件的内容依然是 1381325659。说明第二次执行test.php时，file_put_contents函数没有执行，或者没有执行成功。</p>
<p><strong>追查真凶</strong><br>为什么第二次执行的时候file_put_contents函数没有执行，或者没有执行成功?<br>让我们使用万能的strace命令查看下程序执行过程中，系统调用情况。<br>正常情况下，strace结果中会有如下显示：<br>nanosleep({50, 0}, {50, 0}) = 0<br>write(1, “aaa\n”, 4aaa<br>) = 4<br>lstat(“/tmp/test.txt”, {st_mode=S_IFREG|0644, st_size=10, …}) = 0<br>lstat(“/tmp”, {st_mode=S_IFDIR|S_ISVTX|0777, st_size=1576960, …}) = 0<br>open(“/tmp/test.txt”, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3<br>fstat(3, {st_mode=S_IFREG|0644, st_size=0, …}) = 0<br>lseek(3, 0, SEEK_CUR) = 0<br>write(3, “1381326235”, 10) = 10<br>close(3) = 0<br>close(2) = 0<br>close(1) = 0<br>munmap(0x2b4dd1414000, 4096) = 0<br>close(0) = 0</p>
<p>如果退出ssh后，再登陆，strace结果中会有如下显示：<br>write(1, “aaa\n”, 4) = -1 EIO (Input/output error)<br>close(2) = 0<br>close(1)<br>munmap(0x2b4412622000, 4096) = 0<br>close(0) = 0</p>
<p>注意两次strace的结果蓝色部分。根据strace结果，可以肯定是因为echo时产生了EIO错误导致进程终止，最终没有执行file_put_contents函数。</p>
<p><strong>一追到底</strong><br>为什么退出登陆后，再登陆，就会发生EIO错误呢？这个和linux的会话处理有关。<br>当用户ssh登陆一个服务器时，也就开始了一个会话。会话开始后，标准输入（stdin）、标准输出（stdout）、标准错误（stderr）会连接到一个对应的终端（pty）。</p>
<p>用户登陆后，任何标准输出都会在终端中有反应。标准输出的文件句柄是1。因此，php中的echo(“aaa\n”) 会导致执行系统调用write(1, “aaa\n”, 4). 会在终端中写aaa\n。</p>
<p>当用户退出登陆时，一个会话就结束了。会话结束时，修改所有打开该终端的文件句柄，改成不可读也不可写；</p>
<p>用户退出登陆后再执行write(1, “aaa\n”, 4)，会报EIO错误。因为终端句柄已经不可写。EIO错误发生后，导致进程结束。</p>
<p><strong>解决办法</strong><br>方法一：<br>使用重定向符号&amp;把标准输出重定向到空洞。<br>$ php test.php &gt; /dev/null 2 &gt;&amp;1 &amp;<br>方法二：<br>使用nohup。[推荐使用此方法]<br>$ nohup php test.php &amp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/06/27/在php中如何使用json_decode解析gbk编码的json字符串/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/27/在php中如何使用json_decode解析gbk编码的json字符串/" itemprop="url">在php中如何使用json_decode解析gbk编码的json字符串</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-27T16:00:00+08:00">
                2016-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天遇到用json_decode解析gbk编码的字符串问题。参考了这篇文章.<br>大家都知道，json都是utf8编码的。json_encode后的字符串都是会变成”\u4fe1\u6d77\u9f99”格式。<br>如下面的代码：</p>
<p>输出结果为：”\u4fe1\u6d77\u9f99”</p>
<p>如果你有一个符合json格式的gbk编码的字符串，如何使用json_decode进行解析呢？</p>
<p>答案其实很简单，呵呵。就是把字符串转为utf8编码既可。</p>
<p>你可以在gbk编码的文件中执行如下脚本，看效果。</p>
<p>输出结果如下：<br>NULL string(9) “信海龙”</p>
<p>为什么只要转为utf8编码就可以呢？分析下源码。<br>在ext/json/json.c文件有json_decode的实现。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">PHP_JSON_API void php_json_decode(zval *return_value, char *str, int str_len, zend_bool assoc, long depth TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">    int utf16_len;</span><br><span class="line">    zval *z;</span><br><span class="line">    unsigned short *utf16;</span><br><span class="line">    JSON_parser jp;</span><br><span class="line"> </span><br><span class="line">    utf16 = (unsigned short *) safe_emalloc((str_len+1), sizeof(unsigned short), 1);</span><br><span class="line"> </span><br><span class="line">    utf16_len = utf8_to_utf16(utf16, str, str_len);</span><br><span class="line">    if (utf16_len &lt;= 0) &#123;</span><br><span class="line">        if (utf16) &#123;</span><br><span class="line">            efree(utf16);</span><br><span class="line">        &#125;</span><br><span class="line">        JSON_G(error_code) = PHP_JSON_ERROR_UTF8;</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (depth &lt;= 0) &#123;</span><br><span class="line">        php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Depth must be greater than zero&quot;);</span><br><span class="line">        efree(utf16);</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ALLOC_INIT_ZVAL(z);</span><br><span class="line">    jp = new_JSON_parser(depth);</span><br><span class="line">    if (parse_JSON(jp, z, utf16, utf16_len, assoc TSRMLS_CC)) &#123;</span><br><span class="line">        *return_value = *z;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        double d;</span><br><span class="line">        int type;</span><br><span class="line">        long p;</span><br><span class="line"> </span><br><span class="line">        RETVAL_NULL();</span><br><span class="line">        if (str_len == 4) &#123;</span><br><span class="line">            if (!strcasecmp(str, &quot;null&quot;)) &#123;</span><br><span class="line">                /* We need to explicitly clear the error because its an actual NULL and not an error */</span><br><span class="line">                jp-&gt;error_code = PHP_JSON_ERROR_NONE;</span><br><span class="line">                RETVAL_NULL();</span><br><span class="line">            &#125; else if (!strcasecmp(str, &quot;true&quot;)) &#123;</span><br><span class="line">                RETVAL_BOOL(1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (str_len == 5 &amp;&amp; !strcasecmp(str, &quot;false&quot;)) &#123;</span><br><span class="line">            RETVAL_BOOL(0);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if ((type = is_numeric_string(str, str_len, &amp;p, &amp;d, 0)) != 0) &#123;</span><br><span class="line">            if (type == IS_LONG) &#123;</span><br><span class="line">                RETVAL_LONG(p);</span><br><span class="line">            &#125; else if (type == IS_DOUBLE) &#123;</span><br><span class="line">                RETVAL_DOUBLE(d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if (Z_TYPE_P(return_value) != IS_NULL) &#123;</span><br><span class="line">            jp-&gt;error_code = PHP_JSON_ERROR_NONE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        zval_dtor(z);</span><br><span class="line">    &#125;</span><br><span class="line">    FREE_ZVAL(z);</span><br><span class="line">    efree(utf16);</span><br><span class="line">    JSON_G(error_code) = jp-&gt;error_code;</span><br><span class="line">    free_JSON_parser(jp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意方法中这行代码：<br>utf16_len = utf8_to_utf16(utf16, str, str_len);<br>也就是把utf8编码的串转换为utf16编码串，然后在调用parse_JSON方法解析。找个方法在JSON_parser.c中定义。</p>
<p>看注释，这个方法是需要接收utf16编码的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/06/07/php实现gbk和utf8编码自动识别/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/07/php实现gbk和utf8编码自动识别/" itemprop="url">php实现gbk和utf8编码自动识别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-07T15:00:00+08:00">
                2016-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前中文网页主流的编码为gbk和utf8两种编码。因此，我们做编码识别的前提是，编码不是gbk就是utf8.<br>编码自动识别的基本思想如下：<br>1.看给定的字节串是否符合utf8编码规则。如果不符合则为gbk编码。具体utf8编码规则件日志《<a href="http://www.bo56.com/utf8%E7%BC%96%E7%A0%81%E8%A7%84%E5%88%99/" target="_blank" rel="noopener">utf8编码规则</a>》。<br>2.如果给定的字节串中没有符合utf8三字节规则的，则为gbk编码。中文在utf8中占三个字节。<br>3.如果给定的字节串能对应上gbk编码中的中文，且无法对应上utf8编码中的中文，则为gbk编码。<br>4.特殊情况，特殊处理。如 “鏈條” 和 “瑷媄”。<br>总体思想是，先默认为utf8编码，再根据一些非utf8编码的情况逐步筛选。</p>
<p>准确率和效率还是不错的。20万多条query，1秒钟就可以处理完。</p>
<p>php代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">function detect_encoding($str)&#123;</span><br><span class="line">    $len = strlen($str);</span><br><span class="line">    $encoding = &quot;utf8&quot;;</span><br><span class="line">    $is_utf8_chinese = false;</span><br><span class="line">    for ($i = 0; $i &lt; $len; $i++) &#123; </span><br><span class="line">        if ( (ord($str[$i]) &gt;&gt; 7) &gt; 0 ) &#123; //非ascii字符</span><br><span class="line">            if (ord($str[$i]) &lt;= 191 ) &#123;</span><br><span class="line">                $encoding = &quot;gbk0&quot;;</span><br><span class="line">                break;</span><br><span class="line">            &#125; else if ( ord($str[$i]) &lt;= 223 ) &#123; //前两位为11</span><br><span class="line">                if ( empty($str[$i+1]) or  ord($str[$i+1]) &gt;&gt; 6 != 2 ) &#123; //紧跟后两位为10</span><br><span class="line">                    $encoding = &quot;gbk1&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $i += 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if ( ord($str[$i]) &lt;= 239 ) &#123; //前三位为111</span><br><span class="line">                if ( empty($str[$i+1]) or  ord($str[$i+1]) &gt;&gt; 6 != 2 or empty($str[$i+2]) or  ord($str[$i+2]) &gt;&gt; 6 != 2) &#123; //紧跟后两位为10</span><br><span class="line">                    $encoding = &quot;gbk2&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $i += 2;</span><br><span class="line">                    $is_utf8_chinese = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if ( ord($str[$i]) &lt;= 247 ) &#123; //前四位为1111</span><br><span class="line">                if ( empty($str[$i+1]) or  ord($str[$i+1]) &gt;&gt; 6 != 2 or empty($str[$i+2]) or  ord($str[$i+2]) &gt;&gt; 6 != 2 or empty($str[$i+3]) or  ord($str[$i+3]) &gt;&gt; 6 != 2) &#123; //紧跟后两位为10</span><br><span class="line">                    $encoding = &quot;gbk3&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $i += 3;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if ( ord($str[$i]) &lt;= 251 ) &#123; //前五位为11111</span><br><span class="line">                if ( empty($str[$i+1]) or  ord($str[$i+1]) &gt;&gt; 6 != 2 or empty($str[$i+2]) or  ord($str[$i+2]) &gt;&gt; 6 != 2 or empty($str[$i+3]) or  ord($str[$i+3]) &gt;&gt; 6 != 2 or empty($str[$i+4]) or  ord($str[$i+4]) &gt;&gt; 6 != 2) &#123; //紧跟后两位为10</span><br><span class="line">                    $encoding = &quot;gbk4&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $i += 4;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if ( ord($str[$i]) &lt;= 253 ) &#123; //前六位为111111</span><br><span class="line">                if ( empty($str[$i+1]) or  ord($str[$i+1]) &gt;&gt; 6 != 2 or empty($str[$i+2]) or  ord($str[$i+2]) &gt;&gt; 6 != 2 or empty($str[$i+3]) or  ord($str[$i+3]) &gt;&gt; 6 != 2 or empty($str[$i+4]) or  ord($str[$i+4]) &gt;&gt; 6 != 2 or empty($str[$i+5]) or  ord($str[$i+5]) &gt;&gt; 6 != 2 ) &#123; //紧跟后两位为10</span><br><span class="line">                    $encoding = &quot;gbk5&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $i += 5;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $encoding = &quot;gbk6&quot;;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if ($is_utf8_chinese == false)&#123;</span><br><span class="line">        $encoding = &quot;gbk10&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($encoding == &quot;utf8&quot; &amp;&amp; preg_match(&quot;/^[&quot;.chr(0xa1).&quot;-&quot;.chr(0xff).&quot;\x20-\x7f]+$/&quot;, $str) &amp;&amp; !preg_match(&quot;/^[\x&#123;4e00&#125;-\x&#123;9fa5&#125;\x20-\x7f]+$/u&quot;, $str)) &#123;</span><br><span class="line">        $encoding = &quot;gbk7&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    //echo $encoding;</span><br><span class="line">    if ($encoding == &quot;utf8&quot;) &#123;</span><br><span class="line">        //echo &quot;utf8&quot;;</span><br><span class="line">        return ($str == &quot;鏈條&quot; || $str == &quot;瑷媄&quot;)? $str: mb_convert_encoding($str, &quot;gbk&quot;, &quot;utf8&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //echo &quot;gbk&quot;;</span><br><span class="line">        return $str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得代码最好在gbk编码中运行，因为代码中有汉字（$str == “鏈條” || $str == “瑷媄”）比较。当然你可以在utf8编码中运行，只要把汉字处理下。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/05/30/php-fpm启动报错Segmentation fault $php_fpm_BIN $php_opts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/30/php-fpm启动报错Segmentation fault $php_fpm_BIN $php_opts/" itemprop="url">php-fpm启动报错Segmentation fault $php_fpm_BIN $php_opts</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-30T19:00:00+08:00">
                2016-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天QA使用php-fpm启动php报错。具体信息如下：</p>
<p>-bash-3.2$ ~/script/client/php-fpm restart<br>Gracefully shutting down php-fpm . done<br>Starting php-fpm [29-Jul-2013 16:11:55] NOTICE: [pool www] ‘user’ directive is ignored when FPM is not running as root<br><strong>/home/script/client/php-fpm: line 52: 11678 Segmentation fault $php_fpm_BIN $php_opts</strong><br>failed</p>
<p>最终发现是php中同时启用了apc和zend opcache两个扩展导致的。猜想应该是这两个扩展冲突，同时启用就会报上面的错误。<br>另外，一些扩展库用的编译库来运行库版本不一致引起的 ，比如gd用的是libpng15编译的，但运行环境却是libpng12的话 就容易有这类的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/upload/image/avatar.jpg"
                alt="Lao Yuan" />
            
              <p class="site-author-name" itemprop="name">Lao Yuan</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lao Yuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
