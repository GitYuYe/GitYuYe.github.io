<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Lao Yuan&#39;s Personal Website">
<meta property="og:url" content="http://gityuanye.cn/index.html">
<meta property="og:site_name" content="Lao Yuan&#39;s Personal Website">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lao Yuan&#39;s Personal Website">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://gityuanye.cn/"/>





  <title>Lao Yuan's Personal Website</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lao Yuan's Personal Website</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">LaoYuan</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/07/18/php-redis秒杀功能/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/18/php-redis秒杀功能/" itemprop="url">php-redis秒杀功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-18T21:45:00+08:00">
                2017-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>抢购、秒杀是如今很常见的一个应用场景，主要需要解决的问题有两个：</p>
<p>1 高并发对数据库产生的压力</p>
<p>2 竞争状态下如何解决库存的正确减少（”超卖”问题）</p>
<p>对于第一个问题，已经很容易想到用缓存来处理抢购，避免直接操作数据库，例如使用Redis。</p>
<p>重点在于第二个问题</p>
<p>常规写法：</p>
<p>查询出对应商品的库存，看是否大于0，然后执行生成订单等操作，但是在判断库存是否大于0处，如果在高并发下就会有问题，导致库存量出现负数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$conn=mysql_connect(&quot;localhost&quot;,&quot;big&quot;,&quot;123456&quot;);    </span><br><span class="line">if(!$conn)&#123;    </span><br><span class="line">    echo &quot;connect failed&quot;;    </span><br><span class="line">    exit;    </span><br><span class="line">&#125;   </span><br><span class="line">mysql_select_db(&quot;big&quot;,$conn);   </span><br><span class="line">mysql_query(&quot;set names utf8&quot;);  </span><br><span class="line">  </span><br><span class="line">$price=10;  </span><br><span class="line">$user_id=1;  </span><br><span class="line">$goods_id=1;  </span><br><span class="line">$sku_id=11;  </span><br><span class="line">$number=1;  </span><br><span class="line">  </span><br><span class="line">//生成唯一订单  </span><br><span class="line">function build_order_no()&#123;  </span><br><span class="line">    return date(&apos;ymd&apos;).substr(implode(NULL, array_map(&apos;ord&apos;, str_split(substr(uniqid(), 7, 13), 1))), 0, 8);  </span><br><span class="line">&#125;  </span><br><span class="line">//记录日志  </span><br><span class="line">function insertLog($event,$type=0)&#123;  </span><br><span class="line">    global $conn;  </span><br><span class="line">    $sql=&quot;insert into ih_log(event,type)   </span><br><span class="line">    values(&apos;$event&apos;,&apos;$type&apos;)&quot;;    </span><br><span class="line">    mysql_query($sql,$conn);    </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">//模拟下单操作  </span><br><span class="line">//库存是否大于0  </span><br><span class="line">$sql=&quot;select number from ih_store where goods_id=&apos;$goods_id&apos; and sku_id=&apos;$sku_id&apos;&quot;;//解锁 此时ih_store数据中goods_id=&apos;$goods_id&apos; and sku_id=&apos;$sku_id&apos; 的数据被锁住(注3)，其它事务必须等待此次事务 提交后才能执行  </span><br><span class="line">$rs=mysql_query($sql,$conn);  </span><br><span class="line">$row=mysql_fetch_assoc($rs);  </span><br><span class="line">if($row[&apos;number&apos;]&gt;0)&#123;//高并发下会导致超卖  </span><br><span class="line">    $order_sn=build_order_no();  </span><br><span class="line">    //生成订单    </span><br><span class="line">    $sql=&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)   </span><br><span class="line">    values(&apos;$order_sn&apos;,&apos;$user_id&apos;,&apos;$goods_id&apos;,&apos;$sku_id&apos;,&apos;$price&apos;)&quot;;    </span><br><span class="line">    $order_rs=mysql_query($sql,$conn);   </span><br><span class="line">      </span><br><span class="line">    //库存减少  </span><br><span class="line">    $sql=&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&apos;$sku_id&apos;&quot;;  </span><br><span class="line">    $store_rs=mysql_query($sql,$conn);    </span><br><span class="line">    if(mysql_affected_rows())&#123;    </span><br><span class="line">        insertLog(&apos;库存减少成功&apos;);  </span><br><span class="line">    &#125;else&#123;    </span><br><span class="line">        insertLog(&apos;库存减少失败&apos;);  </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;else&#123;  </span><br><span class="line">    insertLog(&apos;库存不够&apos;);  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>优化方案1：将库存字段number字段设为unsigned，当库存为0时，因为字段不能为负数，将会返回false</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//库存减少  </span><br><span class="line">$sql=&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&apos;$sku_id&apos; and number&gt;0&quot;;  </span><br><span class="line">$store_rs=mysql_query($sql,$conn);    </span><br><span class="line">if(mysql_affected_rows())&#123;    </span><br><span class="line">    insertLog(&apos;库存减少成功&apos;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优化方案2：使用mysql的事务，锁住操作的行</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$conn=mysql_connect(&quot;localhost&quot;,&quot;big&quot;,&quot;123456&quot;);    </span><br><span class="line">if(!$conn)&#123;    </span><br><span class="line">    echo &quot;connect failed&quot;;    </span><br><span class="line">    exit;    </span><br><span class="line">&#125;   </span><br><span class="line">mysql_select_db(&quot;big&quot;,$conn);   </span><br><span class="line">mysql_query(&quot;set names utf8&quot;);  </span><br><span class="line">  </span><br><span class="line">$price=10;  </span><br><span class="line">$user_id=1;  </span><br><span class="line">$goods_id=1;  </span><br><span class="line">$sku_id=11;  </span><br><span class="line">$number=1;  </span><br><span class="line">  </span><br><span class="line">//生成唯一订单号  </span><br><span class="line">function build_order_no()&#123;  </span><br><span class="line">    return date(&apos;ymd&apos;).substr(implode(NULL, array_map(&apos;ord&apos;, str_split(substr(uniqid(), 7, 13), 1))), 0, 8);  </span><br><span class="line">&#125;  </span><br><span class="line">//记录日志  </span><br><span class="line">function insertLog($event,$type=0)&#123;  </span><br><span class="line">    global $conn;  </span><br><span class="line">    $sql=&quot;insert into ih_log(event,type)   </span><br><span class="line">    values(&apos;$event&apos;,&apos;$type&apos;)&quot;;    </span><br><span class="line">    mysql_query($sql,$conn);    </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">//模拟下单操作  </span><br><span class="line">//库存是否大于0  </span><br><span class="line">mysql_query(&quot;BEGIN&quot;);   //开始事务  </span><br><span class="line">$sql=&quot;select number from ih_store where goods_id=&apos;$goods_id&apos; and sku_id=&apos;$sku_id&apos; FOR UPDATE&quot;;//此时这条记录被锁住,其它事务必须等待此次事务提交后才能执行  </span><br><span class="line">$rs=mysql_query($sql,$conn);  </span><br><span class="line">$row=mysql_fetch_assoc($rs);  </span><br><span class="line">if($row[&apos;number&apos;]&gt;0)&#123;  </span><br><span class="line">    //生成订单   </span><br><span class="line">    $order_sn=build_order_no();   </span><br><span class="line">    $sql=&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)   </span><br><span class="line">    values(&apos;$order_sn&apos;,&apos;$user_id&apos;,&apos;$goods_id&apos;,&apos;$sku_id&apos;,&apos;$price&apos;)&quot;;    </span><br><span class="line">    $order_rs=mysql_query($sql,$conn);   </span><br><span class="line">      </span><br><span class="line">    //库存减少  </span><br><span class="line">    $sql=&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&apos;$sku_id&apos;&quot;;  </span><br><span class="line">    $store_rs=mysql_query($sql,$conn);    </span><br><span class="line">    if(mysql_affected_rows())&#123;    </span><br><span class="line">        insertLog(&apos;库存减少成功&apos;);  </span><br><span class="line">        mysql_query(&quot;COMMIT&quot;);//事务提交即解锁  </span><br><span class="line">    &#125;else&#123;    </span><br><span class="line">        insertLog(&apos;库存减少失败&apos;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;else&#123;  </span><br><span class="line">    insertLog(&apos;库存不够&apos;);  </span><br><span class="line">    mysql_query(&quot;ROLLBACK&quot;);  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>优化方案3：使用非阻塞的文件排他锁</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$conn=mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;123456&quot;);    </span><br><span class="line">if(!$conn)&#123;    </span><br><span class="line">    echo &quot;connect failed&quot;;    </span><br><span class="line">    exit;    </span><br><span class="line">&#125;   </span><br><span class="line">mysql_select_db(&quot;big-bak&quot;,$conn);   </span><br><span class="line">mysql_query(&quot;set names utf8&quot;);  </span><br><span class="line">  </span><br><span class="line">$price=10;  </span><br><span class="line">$user_id=1;  </span><br><span class="line">$goods_id=1;  </span><br><span class="line">$sku_id=11;  </span><br><span class="line">$number=1;  </span><br><span class="line">  </span><br><span class="line">//生成唯一订单号  </span><br><span class="line">function build_order_no()&#123;  </span><br><span class="line">    return date(&apos;ymd&apos;).substr(implode(NULL, array_map(&apos;ord&apos;, str_split(substr(uniqid(), 7, 13), 1))), 0, 8);  </span><br><span class="line">&#125;  </span><br><span class="line">//记录日志  </span><br><span class="line">function insertLog($event,$type=0)&#123;  </span><br><span class="line">    global $conn;  </span><br><span class="line">    $sql=&quot;insert into ih_log(event,type)   </span><br><span class="line">    values(&apos;$event&apos;,&apos;$type&apos;)&quot;;    </span><br><span class="line">    mysql_query($sql,$conn);    </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">$fp = fopen(&quot;lock.txt&quot;, &quot;w+&quot;);  </span><br><span class="line">if(!flock($fp,LOCK_EX | LOCK_NB))&#123;  </span><br><span class="line">    echo &quot;系统繁忙，请稍后再试&quot;;  </span><br><span class="line">    return;  </span><br><span class="line">&#125;  </span><br><span class="line">//下单  </span><br><span class="line">$sql=&quot;select number from ih_store where goods_id=&apos;$goods_id&apos; and sku_id=&apos;$sku_id&apos;&quot;;  </span><br><span class="line">$rs=mysql_query($sql,$conn);  </span><br><span class="line">$row=mysql_fetch_assoc($rs);  </span><br><span class="line">if($row[&apos;number&apos;]&gt;0)&#123;//库存是否大于0  </span><br><span class="line">    //模拟下单操作   </span><br><span class="line">    $order_sn=build_order_no();   </span><br><span class="line">    $sql=&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)   </span><br><span class="line">    values(&apos;$order_sn&apos;,&apos;$user_id&apos;,&apos;$goods_id&apos;,&apos;$sku_id&apos;,&apos;$price&apos;)&quot;;    </span><br><span class="line">    $order_rs=mysql_query($sql,$conn);   </span><br><span class="line">      </span><br><span class="line">    //库存减少  </span><br><span class="line">    $sql=&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&apos;$sku_id&apos;&quot;;  </span><br><span class="line">    $store_rs=mysql_query($sql,$conn);    </span><br><span class="line">    if(mysql_affected_rows())&#123;    </span><br><span class="line">        insertLog(&apos;库存减少成功&apos;);  </span><br><span class="line">        flock($fp,LOCK_UN);//释放锁  </span><br><span class="line">    &#125;else&#123;    </span><br><span class="line">        insertLog(&apos;库存减少失败&apos;);  </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;else&#123;  </span><br><span class="line">    insertLog(&apos;库存不够&apos;);  </span><br><span class="line">&#125;  </span><br><span class="line">fclose($fp);</span><br></pre></td></tr></table></figure>
<p>优化方案4：使用redis队列，因为pop操作是原子的，即使有很多用户同时到达，也是依次执行，推荐使用（mysql事务在高并发下性能下降很厉害，文件锁的方式也是）</p>
<p>先将商品库存如队列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$store=1000;  </span><br><span class="line">$redis=new Redis();  </span><br><span class="line">$result=$redis-&gt;connect(&apos;127.0.0.1&apos;,6379);  </span><br><span class="line">$res=$redis-&gt;llen(&apos;goods_store&apos;);  </span><br><span class="line">echo $res;  </span><br><span class="line">$count=$store-$res;  </span><br><span class="line">for($i=0;$i&lt;$count;$i++)&#123;  </span><br><span class="line">    $redis-&gt;lpush(&apos;goods_store&apos;,1);  </span><br><span class="line">&#125;  </span><br><span class="line">echo $redis-&gt;llen(&apos;goods_store&apos;);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>抢购、描述逻辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$conn=mysql_connect(&quot;localhost&quot;,&quot;big&quot;,&quot;123456&quot;);    </span><br><span class="line">if(!$conn)&#123;    </span><br><span class="line">    echo &quot;connect failed&quot;;    </span><br><span class="line">    exit;    </span><br><span class="line">&#125;   </span><br><span class="line">mysql_select_db(&quot;big&quot;,$conn);   </span><br><span class="line">mysql_query(&quot;set names utf8&quot;);  </span><br><span class="line">  </span><br><span class="line">$price=10;  </span><br><span class="line">$user_id=1;  </span><br><span class="line">$goods_id=1;  </span><br><span class="line">$sku_id=11;  </span><br><span class="line">$number=1;  </span><br><span class="line">  </span><br><span class="line">//生成唯一订单号  </span><br><span class="line">function build_order_no()&#123;  </span><br><span class="line">    return date(&apos;ymd&apos;).substr(implode(NULL, array_map(&apos;ord&apos;, str_split(substr(uniqid(), 7, 13), 1))), 0, 8);  </span><br><span class="line">&#125;  </span><br><span class="line">//记录日志  </span><br><span class="line">function insertLog($event,$type=0)&#123;  </span><br><span class="line">    global $conn;  </span><br><span class="line">    $sql=&quot;insert into ih_log(event,type)   </span><br><span class="line">    values(&apos;$event&apos;,&apos;$type&apos;)&quot;;    </span><br><span class="line">    mysql_query($sql,$conn);    </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">//模拟下单操作  </span><br><span class="line">//下单前判断redis队列库存量  </span><br><span class="line">$redis=new Redis();  </span><br><span class="line">$result=$redis-&gt;connect(&apos;127.0.0.1&apos;,6379);  </span><br><span class="line">$count=$redis-&gt;lpop(&apos;goods_store&apos;);  </span><br><span class="line">if(!$count)&#123;  </span><br><span class="line">    insertLog(&apos;error:no store redis&apos;);  </span><br><span class="line">    return;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">//生成订单    </span><br><span class="line">$order_sn=build_order_no();  </span><br><span class="line">$sql=&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)   </span><br><span class="line">values(&apos;$order_sn&apos;,&apos;$user_id&apos;,&apos;$goods_id&apos;,&apos;$sku_id&apos;,&apos;$price&apos;)&quot;;    </span><br><span class="line">$order_rs=mysql_query($sql,$conn);   </span><br><span class="line">  </span><br><span class="line">//库存减少  </span><br><span class="line">$sql=&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&apos;$sku_id&apos;&quot;;  </span><br><span class="line">$store_rs=mysql_query($sql,$conn);    </span><br><span class="line">if(mysql_affected_rows())&#123;    </span><br><span class="line">    insertLog(&apos;库存减少成功&apos;);  </span><br><span class="line">&#125;else&#123;    </span><br><span class="line">    insertLog(&apos;库存减少失败&apos;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模拟5000高并发测试</p>
<p>webbench -c 5000 -t 60 <a href="http://192.168.1.198/big/index.php" target="_blank" rel="noopener">http://192.168.1.198/big/index.php</a></p>
<p>ab -r -n 6000 -c 5000 <a href="http://192.168.1.198/big/index.php" target="_blank" rel="noopener">http://192.168.1.198/big/index.php</a></p>
<p>上述只是简单模拟高并发下的抢购，真实场景要比这复杂很多，很多注意的地方<br>如抢购页面做成静态的，通过ajax调用接口<br>再如上面的会导致一个用户抢多个，思路：<br>需要一个排队队列和抢购结果队列及库存队列。高并发情况，先将用户进入排队队列，用一个线程循环处理从排队队列取出一个用户，判断用户是否已在抢购结果队列，如果在，则已抢购，否则未抢购，库存减1，写数据库，将用户入结果队列。</p>
<p>测试数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">--  </span><br><span class="line">-- 数据库: `big`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">-- --------------------------------------------------------  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 表的结构 `ih_goods`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE IF NOT EXISTS `ih_goods` (  </span><br><span class="line">  `goods_id` int(10) unsigned NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `cat_id` int(11) NOT NULL,  </span><br><span class="line">  `goods_name` varchar(255) NOT NULL,  </span><br><span class="line">  PRIMARY KEY (`goods_id`)  </span><br><span class="line">) ENGINE=MyISAM  DEFAULT CHARSET=utf8 AUTO_INCREMENT=2 ;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 转存表中的数据 `ih_goods`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">INSERT INTO `ih_goods` (`goods_id`, `cat_id`, `goods_name`) VALUES  </span><br><span class="line">(1, 0, &apos;小米手机&apos;);  </span><br><span class="line">  </span><br><span class="line">-- --------------------------------------------------------  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 表的结构 `ih_log`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE IF NOT EXISTS `ih_log` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `event` varchar(255) NOT NULL,  </span><br><span class="line">  `type` tinyint(4) NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `addtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 转存表中的数据 `ih_log`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">-- --------------------------------------------------------  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 表的结构 `ih_order`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE IF NOT EXISTS `ih_order` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `order_sn` char(32) NOT NULL,  </span><br><span class="line">  `user_id` int(11) NOT NULL,  </span><br><span class="line">  `status` int(11) NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `goods_id` int(11) NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `sku_id` int(11) NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `price` float NOT NULL,  </span><br><span class="line">  `addtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&apos;订单表&apos; AUTO_INCREMENT=1 ;  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 转存表中的数据 `ih_order`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">-- --------------------------------------------------------  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 表的结构 `ih_store`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE IF NOT EXISTS `ih_store` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `goods_id` int(11) NOT NULL,  </span><br><span class="line">  `sku_id` int(10) unsigned NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `number` int(10) NOT NULL DEFAULT &apos;0&apos;,  </span><br><span class="line">  `freez` int(11) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;虚拟库存&apos;,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COMMENT=&apos;库存&apos; AUTO_INCREMENT=2 ;  </span><br><span class="line">  </span><br><span class="line">--  </span><br><span class="line">-- 转存表中的数据 `ih_store`  </span><br><span class="line">--  </span><br><span class="line">  </span><br><span class="line">INSERT INTO `ih_store` (`id`, `goods_id`, `sku_id`, `number`, `freez`) VALUES  </span><br><span class="line">(1, 1, 11, 500, 0);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/07/03/MySQL性能优化总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/03/MySQL性能优化总结/" itemprop="url">MySQL性能优化总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-03T20:45:00+08:00">
                2017-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>收藏网上一篇文章</p>
<p><strong>一、MySQL**</strong>的主要适用场景**</p>
<p>1、Web网站系统</p>
<p>2、日志记录系统</p>
<p>3、数据仓库系统</p>
<p>4、嵌入式系统</p>
<p><strong>二、**</strong>MySQL<strong><em>\</em>架构图：</strong></p>
<p><strong><img src="http://images0.cnblogs.com/blog2015/434101/201508/011457079079467.jpg" alt="img"></strong></p>
<p><strong>三、**</strong>MySQL<strong><em>\</em>存储引擎概述</strong></p>
<p><strong>1**</strong>）<strong>MyISAM</strong>存储引擎**</p>
<p>MyISAM存储引擎的表在数据库中，每一个表都被存放为三个以表名命名的物理文件。首先肯定会有任何存储引擎都不可缺少的存放表结构定义信息的.frm文件，另外还有.MYD和.MYI文件，分别存放了表的数据（.MYD）和索引数据（.MYI）。每个表都有且仅有这样三个文件做为MyISAM存储类型的表的存储，也就是说不管这个表有多少个索引，都是存放在同一个.MYI文件中。</p>
<p>MyISAM支持以下三种类型的索引：</p>
<p>1、B-Tree索引</p>
<p>B-Tree索引，顾名思义，就是所有的索引节点都按照balancetree的数据结构来存储，所有的索引数据节点都在叶节点。</p>
<p>2、R-Tree索引</p>
<p>R-Tree索引的存储方式和b-tree索引有一些区别，主要设计用于为存储空间和多维数据的字段做索引，所以目前的MySQL版本来说，也仅支持geometry类型的字段作索引。</p>
<p>3、Full-text索引</p>
<p>Full-text索引就是我们长说的全文索引，他的存储结构也是b-tree。主要是为了解决在我们需要用like查询的低效问题。</p>
<p><strong>2**</strong>）<strong>Innodb</strong> 存储引擎**</p>
<p>1、支持事务安装</p>
<p>2、数据多版本读取</p>
<p>3、锁定机制的改进</p>
<p>4、实现外键</p>
<p><strong>3**</strong>）<strong>NDBCluster</strong>存储引擎**</p>
<p>NDB存储引擎也叫NDBCluster存储引擎，主要用于MySQLCluster分布式集群环境，Cluster是MySQL从5.0版本才开始提供的新功能。</p>
<p><strong>4**</strong>）<strong>Merge</strong>存储引擎**</p>
<p>MERGE存储引擎，在MySQL用户手册中也提到了，也被大家认识为MRG_MyISAM引擎。Why？因为MERGE存储引擎可以简单的理解为其功能就是实现了对结构相同的MyISAM表，通过一些特殊的包装对外提供一个单一的访问入口，以达到减小应用的复杂度的目的。要创建MERGE表，不仅仅基表的结构要完全一致，包括字段的顺序，基表的索引也必须完全一致。</p>
<p><strong>5**</strong>）<strong>Memory</strong>存储引擎**</p>
<p>Memory存储引擎，通过名字就很容易让人知道，他是一个将数据存储在内存中的存储引擎。Memory存储引擎不会将任何数据存放到磁盘上，仅仅存放了一个表结构相关信息的.frm文件在磁盘上面。所以一旦MySQLCrash或者主机Crash之后，Memory的表就只剩下一个结构了。Memory表支持索引，并且同时支持Hash和B－Tree两种格式的索引。由于是存放在内存中，所以Memory都是按照定长的空间来存储数据的，而且不支持BLOB和TEXT类型的字段。Memory存储引擎实现页级锁定。</p>
<p><strong>6**</strong>）<strong>BDB</strong>存储引擎**</p>
<p>BDB存储引擎全称为BerkeleyDB存储引擎，和Innodb一样，也不是MySQL自己开发实现的一个存储引擎，而是由SleepycatSoftware所提供，当然，也是开源存储引擎，同样支持事务安全。</p>
<p><strong>7**</strong>）<strong>FEDERATED</strong>存储引擎**</p>
<p>FEDERATED存储引擎所实现的功能，和Oracle的DBLINK基本相似，主要用来提供对远程MySQL服务器上面的数据的访问接口。如果我们使用源码编译来安装MySQL，那么必须手工指定启用FEDERATED存储引擎才行，因为MySQL默认是不起用该存储引擎的。</p>
<p><strong>8**</strong>）<strong>ARCHIVE</strong>存储引擎**</p>
<p>ARCHIVE存储引擎主要用于通过较小的存储空间来存放过期的很少访问的历史数据。ARCHIVE表不支持索引，通过一个.frm的结构定义文件，一个.ARZ的数据压缩文件还有一个.ARM的meta信息文件。由于其所存放的数据的特殊性，ARCHIVE表不支持删除，修改操</p>
<p>作，仅支持插入和查询操作。锁定机制为行级锁定。</p>
<p><strong>9**</strong>）<strong>BLACKHOLE</strong>存储引擎**</p>
<p>BLACKHOLE存储引擎是一个非常有意思的存储引擎，功能恰如其名，就是一个“黑洞”。就像我们unix系统下面的“/dev/null”设备一样，不管我们写入任何信息，都是有去无回。</p>
<p><strong>10**</strong>）<strong>CSV</strong>存储引擎**</p>
<p>CSV存储引擎实际上操作的就是一个标准的CSV文件，他不支持索引。起主要用途就是大家有些时候可能会需要通过数据库中的数据导出成一份报表文件，而CSV文件是很多软件都支持的一种较为标准的格式，所以我们可以通过先在数据库中建立一张CVS表，然后将生成的报表信息插入到该表，即可得到一份CSV报表文件了。</p>
<p><strong>四、影响**</strong>MySQLServer<strong><em>\</em>性能的相关因素</strong></p>
<p><strong>1**</strong>商业需求对性能的影响**</p>
<p>典型需求：一个论坛帖子总量的统计，要求：实时更新。</p>
<p><strong>2**</strong>系统架构及实现对性能的影响**</p>
<p>以下几类数据都是不适合在数据库中存放的：</p>
<p>二进制多媒体数据</p>
<p>流水队列数据</p>
<p>超大文本数据</p>
<p>通过Cache技术来提高系统性能：</p>
<p>系统各种配置及规则数据；</p>
<p>活跃用户的基本信息数据；</p>
<p>活跃用户的个性化定制信息数据；</p>
<p>准实时的统计信息数据；</p>
<p>其他一些访问频繁但变更较少的数据；</p>
<p><strong>3 Query**</strong>语句对系统性能的影响**</p>
<p>需求：取出某个group（假设id为1）下的用户编号（id），用户昵称（nick_name），并按照加入组的时间（user_group.gmt_create）来进行倒序排列，取出前20个。</p>
<p>解决方案一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,nick_name FROM user,user_group WHERE user_group.group_id=1 and user_group.user_id=user.id ORDER BY user_group.gmt_create desc limit 100,20;</span><br></pre></td></tr></table></figure>
<p>解决方案二：</p>
<p><a href="javascript:void(0" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a>;)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT user.id,user.nick_name FROM(</span><br><span class="line">SELECT user_id</span><br><span class="line">FROM user_group</span><br><span class="line">WHERE user_group.group_id=1</span><br><span class="line">ORDER BY gmt_create desc</span><br><span class="line">limit 100,20)t,user</span><br><span class="line">WHERE t.user_id=user.id;</span><br></pre></td></tr></table></figure>
<p><a href="javascript:void(0" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a>;)</p>
<p>通过比较两个解决方案的执行计划，我们可以看到第一中解决方案中需要和user表参与Join的记录数MySQL通过统计数据估算出来是31156，也就是通过user_group表返回的所有满足group_id=1的记录数（系统中的实际数据是20000）。而第二种解决方案的执行计划中，user表参与Join的数据就只有20条，两者相差很大，我们认为第二中解决方案应该明显优于第一种解决方案。</p>
<p><strong>4 Schema**</strong>设计对系统的性能影响**</p>
<p>尽量减少对数据库访问的请求。</p>
<p>尽量减少无用数据的查询请求。</p>
<p><strong>5**</strong>硬件环境对系统性能的影响**</p>
<p>1、典型OLTP应用系统</p>
<p>对于各种数据库系统环境中大家最常见的OLTP系统，其特点是并发量大，整体数据量比较多，但每次访问的数据比较少，且访问的数据比较离散，活跃数据占总体数据的比例不是太大。对于这类系统的数据库实际上是最难维护，最难以优化的，对主机整体性能要求也是最高的。因为不仅访问量很高，数据量也不小。</p>
<p>针对上面的这些特点和分析，我们可以对OLTP的得出一个大致的方向。</p>
<p>虽然系统总体数据量较大，但是系统活跃数据在数据总量中所占的比例不大，那么我们可以通过扩大内存容量来尽可能多的将活跃数据cache到内存中；</p>
<p>虽然IO访问非常频繁，但是每次访问的数据量较少且很离散，那么我们对磁盘存储的要求是IOPS表现要很好，吞吐量是次要因素；</p>
<p>并发量很高，CPU每秒所要处理的请求自然也就很多，所以CPU处理能力需要比较强劲；</p>
<p>虽然与客户端的每次交互的数据量并不是特别大，但是网络交互非常频繁，所以主机与客户端交互的网络设备对流量能力也要求不能太弱。</p>
<p>2、典型OLAP应用系统</p>
<p>用于数据分析的OLAP系统的主要特点就是数据量非常大，并发访问不多，但每次访问所需要检索的数据量都比较多，而且数据访问相对较为集中，没有太明显的活跃数据概念。</p>
<p>基于OLAP系统的各种特点和相应的分析，针对OLAP系统硬件优化的大致策略如下：</p>
<p>数据量非常大，所以磁盘存储系统的单位容量需要尽量大一些；</p>
<p>单次访问数据量较大，而且访问数据比较集中，那么对IO系统的性能要求是需要有尽可能大的每秒IO吞吐量，所以应该选用每秒吞吐量尽可能大的磁盘；</p>
<p>虽然IO性能要求也比较高，但是并发请求较少，所以CPU处理能力较难成为性能瓶颈，所以CPU处理能力没有太苛刻的要求；</p>
<p>虽然每次请求的访问量很大，但是执行过程中的数据大都不会返回给客户端，最终返回给客户端的数据量都较小，所以和客户端交互的网络设备要求并不是太高；</p>
<p>此外，由于OLAP系统由于其每次运算过程较长，可以很好的并行化，所以一般的OLAP系统都是由多台主机构成的一个集群，而集群中主机与主机之间的数据交互量一般来说都是非常大的，所以在集群中主机之间的网络设备要求很高。</p>
<p>3、除了以上两个典型应用之外，还有一类比较特殊的应用系统，他们的数据量不是特别大，但是访问请求及其频繁，而且大部分是读请求。可能每秒需要提供上万甚至几万次请求，每次请求都非常简单，可能大部分都只有一条或者几条比较小的记录返回，就比如基于数据库的DNS服务就是这样类型的服务。</p>
<p>虽然数据量小，但是访问极其频繁，所以可以通过较大的内存来cache住大部分的数据，这能够保证非常高的命中率，磁盘IO量比较小，所以磁盘也不需要特别高性能的；</p>
<p>并发请求非常频繁，比需要较强的CPU处理能力才能处理；</p>
<p>虽然应用与数据库交互量非常大，但是每次交互数据较少，总体流量虽然也会较大，但是一般来说普通的千兆网卡已经足够了。</p>
<p><strong>五、**</strong>MySQL <strong><em>\</em>锁定机制简介</strong></p>
<p>行级锁定（row-level）</p>
<p>表级锁定（table-level）</p>
<p>页级锁定（page-level）</p>
<p>在MySQL数据库中，使用表级锁定的主要是MyISAM，Memory，CSV等一些非事务性存储引擎，而使用行级锁定的主要是Innodb存储引擎和NDBCluster存储引擎，页级锁定主要是BerkeleyDB存储引擎的锁定方式。</p>
<p><strong>六、**</strong>MySQL Query<strong><em>\</em>的优化</strong></p>
<p>Query语句的优化思路和原则主要提现在以下几个方面：</p>
<p>\1. 优化更需要优化的Query；</p>
<p>\2. 定位优化对象的性能瓶颈；</p>
<p>\3. 明确的优化目标；</p>
<p>\4. 从Explain入手；</p>
<p>\5. 多使用profile</p>
<p>\6. 永远用小结果集驱动大的结果集；</p>
<p>\7. 尽可能在索引中完成排序；</p>
<p>\8. 只取出自己需要的Columns；</p>
<p>\9. 仅仅使用最有效的过滤条件；</p>
<p>10.尽可能避免复杂的Join和子查询；</p>
<p><strong>合理设计并利用索引</strong></p>
<p>1）B-Tree索引</p>
<p>一般来说，MySQL中的B-Tree索引的物理文件大多都是以BalanceTree的结构来存储的，也就是所有实际需要的数据都存放于Tree的LeafNode，而且到任何一个LeafNode的最短路径的长度都是完全相同的，所以我们大家都称之为B-Tree索引当然，可能各种数据库（或MySQL的各种存储引擎）在存放自己的B-Tree索引的时候会对存储结构稍作改造。如Innodb存储引擎的B-Tree索引实际使用的存储结构实际上是B+Tree，也就是在B-Tree数据结构的基础上做了很小的改造，在每一个LeafNode上面出了存放索引键的相关信息之外，还存储了指向与该LeafNode相邻的后一个LeafNode的指针信息，这主要是为了加快检索多个相邻LeafNode的效率考虑。</p>
<p>2）Hash索引</p>
<p>Hash索引在MySQL中使用的并不是很多，目前主要是Memory存储引擎使用，而且在Memory存储引擎中将Hash索引作为默认的索引类型。所谓Hash索引，实际上就是通过一定的Hash算法，将需要索引的键值进行Hash运算，然后将得到的Hash值存入一个Hash表中。然后每次需要检索的时候，都会将检索条件进行相同算法的Hash运算，然后再和Hash表中的Hash值进行比较并得出相应的信息。</p>
<p>Hash索引仅仅只能满足“=”,“IN”和“&lt;=&gt;”查询，不能使用范围查询；</p>
<p>Hash索引无法被利用来避免数据的排序操作；</p>
<p>Hash索引不能利用部分索引键查询；</p>
<p>Hash索引在任何时候都不能避免表扫面；</p>
<p>Hash索引遇到大量Hash值相等的情况后性能并不一定就会比B-Tree索引高；</p>
<p>3）Full-text索引</p>
<p>Full-text索引也就是我们常说的全文索引，目前在MySQL中仅有MyISAM存储引擎支持，而且也并不是所有的数据类型都支持全文索引。目前来说，仅有CHAR，VARCHAR和TEXT这三种数据类型的列可以建Full-text索引。</p>
<p>索引能够极大的提高数据检索效率，也能够改善排序分组操作的性能，但是我们不能忽略的一个问题就是索引是完全独立于基础数据之外的一部分数据，更新数据会带来的IO量和调整索引所致的计算量的资源消耗。</p>
<p>是否需要创建索引，几点原则：较频繁的作为查询条件的字段应该创建索引；唯一性太差的字段不适合单独创建索引，即使频繁作为查询条件；更新非常频繁的字段不适合创建索引；</p>
<p>不会出现在WHERE子句中的字段不该创建索引；</p>
<p><strong>Join**</strong>语句的优化**</p>
<p>尽可能减少Join语句中的NestedLoop的循环总次数；“永远用小结果集驱动大的结果集”。</p>
<p>优先优化NestedLoop的内层循环；</p>
<p>保证Join语句中被驱动表上Join条件字段已经被索引；</p>
<p>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置；</p>
<p><strong>ORDER BY**</strong>，<strong>GROUP BY</strong>和<strong>DISTINCT</strong>优化**</p>
<p>1）ORDER BY的实现与优化</p>
<p>优化Query语句中的ORDER BY的时候，尽可能利用已有的索引来避免实际的排序计算，可以很大幅度的提升ORDER BY操作的性能。</p>
<p>优化排序：</p>
<p>1.加大max_length_for_sort_data参数的设置；</p>
<p>2.去掉不必要的返回字段；</p>
<p>3.增大sort_buffer_size参数设置；</p>
<p>2）GROUP BY的实现与优化</p>
<p>由于GROUP BY实际上也同样需要进行排序操作，而且与ORDER BY相比，GROUP BY主要只是多了排序之后的分组操作。当然，如果在分组的时候还使用了其他的一些聚合函数，那么还需要一些聚合函数的计算。所以，在GROUP BY的实现过程中，与ORDER BY一样也可以利用到索引。</p>
<p>3）DISTINCT的实现与优化</p>
<p>DISTINCT实际上和GROUP BY的操作非常相似，只不过是在GROUP BY之后的每组中只取出一条记录而已。所以，DISTINCT的实现和GROUP BY的实现也基本差不多，没有太大的区别。同样可以通过松散索引扫描或者是紧凑索引扫描来实现，当然，在无法仅仅使用索引即能完成DISTINCT的时候，MySQL只能通过临时表来完成。但是，和GROUP BY有一点差别的是，DISTINCT并不需要进行排序。也就是说，在仅仅只是DISTINCT操作的Query如果无法仅仅利用索引完成操作的时候，MySQL会利用临时表来做一次数据的“缓存”，但是不会对临时表中的数据进行filesort操作。</p>
<p><strong>七、**</strong>MySQL<strong>数据库</strong>Schema<strong><em>\</em>设计的性能优化</strong></p>
<p><strong>高效的模型设计</strong></p>
<p>适度冗余-让Query尽两减少Join</p>
<p>大字段垂直分拆-summary表优化</p>
<p>大表水平分拆-基于类型的分拆优化</p>
<p>统计表-准实时优化</p>
<p><strong>合适的数据类型</strong></p>
<p><a href="http://images0.cnblogs.com/blog2015/434101/201508/011503463921628.jpg" target="_blank" rel="noopener"><img src="http://images0.cnblogs.com/blog2015/434101/201508/011503463921628.jpg" alt="img"></a></p>
<p>时间存储格式总类并不是太多，我们常用的主要就是DATETIME，DATE和TIMESTAMP这三种了。从存储空间来看TIMESTAMP最少，四个字节，而其他两种数据类型都是八个字节，多了一倍。而TIMESTAMP的缺点在于他只能存储从1970年之后的时间，而另外两种时间类型可以存放最早从1001年开始的时间。如果有需要存放早于1970年之前的时间的需求，我们必须放弃TIMESTAMP类型，但是只要我们不需要使用1970年之前的时间，最好尽量使用TIMESTAMP来减少存储空间的占用。</p>
<p>字符存储类型</p>
<p><a href="http://images0.cnblogs.com/blog2015/434101/201508/011504166424919.jpg" target="_blank" rel="noopener"><img src="http://images0.cnblogs.com/blog2015/434101/201508/011504166424919.jpg" alt="img"></a></p>
<p>CHAR[(M)]类型属于静态长度类型，存放长度完全以字符数来计算，所以最终的存储长度是基于字符集的，如latin1则最大存储长度为255字节，但是如果使用gbk则最大存储长度为510字节。CHAR类型的存储特点是不管我们实际存放多长数据，在数据库中都会存放M个字符，不够的通过空格补上，M默认为1。虽然CHAR会通过空格补齐存放的空间，但是在访问数据的时候，MySQL会忽略最后的所有空格，所以如果我们的实际数据中如果在最后确实需要空格，则不能使用CHAR类型来存放。</p>
<p>VARCHAR[(M)]属于动态存储长度类型，仅存占用实际存储数据的长度。TINYTEXT，TEXT，MEDIUMTEXT和LONGTEXT这四种类型同属于一种存储方式，都是动态存储长度类型，不同的仅仅是最大长度的限制。</p>
<p><strong>事务优化</strong></p>
<ol>
<li>脏读：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</li>
<li>不可重复读：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。</li>
<li>幻读：是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。</li>
</ol>
<p>Innodb在事务隔离级别方面支持的信息如下：</p>
<p>1.READ UNCOMMITTED</p>
<p>常被成为Dirty Reads（脏读），可以说是事务上的最低隔离级别：在普通的非锁定模式下SELECT的执行使我们看到的数据可能并不是查询发起时间点的数据，因而在这个隔离度下是非Consistent Reads（一致性读）；</p>
<p>2.READ COMMITTED</p>
<p>这一隔离级别下，不会出现DirtyRead，但是可能出现Non-RepeatableReads(不可重复读)和PhantomReads（幻读）。</p>
<p>\3. REPEATABLE READ</p>
<p>REPEATABLE READ隔离级别是InnoDB默认的事务隔离级。在REPEATABLE READ隔离级别下，不会出现DirtyReads，也不会出现Non-Repeatable Read，但是仍然存在PhantomReads的可能性。</p>
<p>4.SERIALIZABLE</p>
<p>SERIALIZABLE隔离级别是标准事务隔离级别中的最高级别。设置为SERIALIZABLE隔离级别之后，在事务中的任何时候所看到的数据都是事务启动时刻的状态，不论在这期间有没有其他事务已经修改了某些数据并提交。所以，SERIALIZABLE事务隔离级别下，PhantomReads也不会出现。</p>
<p><strong>八、可扩展性设计之数据切分</strong></p>
<p><strong>数据的垂直切分</strong></p>
<p>数据的垂直切分，也可以称之为纵向切分。将数据库想象成为由很多个一大块一大块的“数据块”（表）组成，我们垂直的将这些“数据块”切开，然后将他们分散到多台数据库主机上面。这样的切分方法就是一个垂直（纵向）的数据切分。</p>
<p>垂直切分的优点</p>
<p>◆数据库的拆分简单明了，拆分规则明确；</p>
<p>◆应用程序模块清晰明确，整合容易；</p>
<p>◆数据维护方便易行，容易定位；</p>
<p>垂直切分的缺点</p>
<p>◆部分表关联无法在数据库级别完成，需要在程序中完成；</p>
<p>◆对于访问极其频繁且数据量超大的表仍然存在性能平静，不一定能满足要求；</p>
<p>◆事务处理相对更为复杂；</p>
<p>◆切分达到一定程度之后，扩展性会遇到限制；</p>
<p>◆过读切分可能会带来系统过渡复杂而难以维护。</p>
<p><strong>数据的水平切分</strong></p>
<p>数据的垂直切分基本上可以简单的理解为按照表按照模块来切分数据，而水平切分就不再是按照表或者是功能模块来切分了。一般来说，简单的水平切分主要是将某个访问极其平凡的表再按照某个字段的某种规则来分散到多个表之中，每个表中包含一部分数据。</p>
<p>水平切分的优点</p>
<p>◆表关联基本能够在数据库端全部完成；</p>
<p>◆不会存在某些超大型数据量和高负载的表遇到瓶颈的问题；</p>
<p>◆应用程序端整体架构改动相对较少；</p>
<p>◆事务处理相对简单；</p>
<p>◆只要切分规则能够定义好，基本上较难遇到扩展性限制；</p>
<p>水平切分的缺点</p>
<p>◆切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则；</p>
<p>◆后期数据的维护难度有所增加，人为手工定位数据更困难；</p>
<p>◆应用系统各模块耦合度较高，可能会对后面数据的迁移拆分造成一定的困难。</p>
<p><strong>数据切分与整合中可能存在的问题</strong></p>
<p>1.引入分布式事务的问题</p>
<p>完全可以将一个跨多个数据库的分布式事务分拆成多个仅处于单个数据库上面的小事务，并通过应用程序来总控各个小事务。当然，这样作的要求就是我们的俄应用程序必须要有足够的健壮性，当然也会给应用程序带来一些技术难度。</p>
<p>2.跨节点Join的问题</p>
<p>推荐通过应用程序来进行处理，先在驱动表所在的MySQLServer中取出相应的驱动结果集，然后根据驱动结果集再到被驱动表所在的MySQL Server中取出相应的数据。</p>
<p>3.跨节点合并排序分页问题</p>
<p>从多个数据源并行的取数据，然后应用程序汇总处理。</p>
<p><strong>九、可扩展性设计之**</strong>Cache<strong>与</strong>Search<strong><em>\</em>的利用</strong></p>
<p>通过引入Cache（Redis、Memcached），减少数据库的访问，增加性能。</p>
<p>通过引入Search（Lucene、Solr、ElasticSearch），利用搜索引擎高效的全文索引和分词算法，以及高效的数据检索实现，来解决数据库和传统的Cache软件完全无法解决的全文模糊搜索、分类统计查询等功能。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/06/13/使用Redis实现购物车功能/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/13/使用Redis实现购物车功能/" itemprop="url">使用Redis实现购物车功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T18:05:00+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="使用Redis实现购物车功能"><a href="#使用Redis实现购物车功能" class="headerlink" title="使用Redis实现购物车功能"></a>使用Redis实现购物车功能</h4><p>一般情况下购物车功能都是使用SESSION/COOKIE实现的，也就是将整个购物车数据都存储到SESSION中。这样做的好处就是不用操作数据库就可以实现，同时用户可以不同登录就可以将商品加入到购物车中，缺点就是1. 导致SESSION过于臃肿 2. SESSION数据默认是存储到文件中的，所以操作SESSION是相对比较慢的。而将购物车数据存放到Redis中，可以加快购物车的读写性能，从而提高用户体验，缺点就是Redis数据是存放到内存，相对成本高</p>
<h3 id="核心代码如下"><a href="#核心代码如下" class="headerlink" title="核心代码如下"></a>核心代码如下</h3><p>Cart.class.php代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"></span><br><span class="line">//使用redis实现一个购物车功能</span><br><span class="line">class Cart</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  购物车有功能： 1、 将商品添加到购物车中  2、改变购物车商品数量  3、显示购物车的信息</span><br><span class="line">     *</span><br><span class="line">     *</span><br><span class="line">     * 将商品添加到购物车中功能分析如下：</span><br><span class="line">     * 1. 接收到商品ID</span><br><span class="line">     * 2. 根据商品ID查询商品信息</span><br><span class="line">     * 3. 将商品信息加入到购物车中</span><br><span class="line">     *</span><br><span class="line">     *         a. 判断购物车是否已有对应商品</span><br><span class="line">     *         b. 如果购物车中没有对应的商品，直接加入</span><br><span class="line">     *         c. 如果购物车中有对应的商品，只要修改商品数量</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        //如果成员属性没有声明，默认就是公有属性</span><br><span class="line">        $this-&gt;redis = new Redis;</span><br><span class="line">        $this-&gt;redis-&gt;connect(&apos;127.0.0.1&apos;, 6379);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function addToCart($gid, $cartNum=1)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        session_start();</span><br><span class="line">        if ($gid &lt;= 0) &#123;</span><br><span class="line"></span><br><span class="line">            throw new Exception(&quot;请输入商品ID&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //根据商品ID查询商品数据</span><br><span class="line">        $goodData = $this-&gt;goodsData($gid);</span><br><span class="line"></span><br><span class="line">        $key = &apos;cart:&apos;.session_id().&apos;:&apos;.$gid;//id 说明：1、不仅仅要区分商品  2、 用户</span><br><span class="line"></span><br><span class="line">        // $data = $this-&gt;redis-&gt;hget($key, &apos;id&apos;);</span><br><span class="line">        $data = $this-&gt;redis-&gt;exists($key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //判断购物车中是否有无商品，然后根据情况加入购物车</span><br><span class="line">        if (!$data) &#123;</span><br><span class="line"></span><br><span class="line">            //购物车之前没有对应的商品的</span><br><span class="line"></span><br><span class="line">            //购物车的商品数量</span><br><span class="line">            $goodData[&apos;num&apos;] = $cartNum;</span><br><span class="line"></span><br><span class="line">            //将商品数据存放到redis中hash</span><br><span class="line">            $this-&amp;gt;redis-&amp;gt;hmset($key, $goodData);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            $key1 = &apos;cart:ids:set:&apos;.session_id();</span><br><span class="line"></span><br><span class="line">            //将商品ID存放集合中,是为了更好将用户的购物车的商品给遍历出来</span><br><span class="line">            $this-&amp;gt;redis-&amp;gt;sadd($key1, $gid);</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line"></span><br><span class="line">            //购物车有对应的商品，只需要添加对应商品的数量</span><br><span class="line">            $originNum = $this-&gt;redis-&gt;hget($key, &apos;num&apos;);</span><br><span class="line"></span><br><span class="line">            //原来的数量加上用户新加入的数量</span><br><span class="line">            $newNum = $originNum + $cartNum;</span><br><span class="line"></span><br><span class="line">            $this-&amp;gt;redis-&amp;gt;hset($key, &apos;num&apos;, $newNum);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //显示用户购物车的所有商品</span><br><span class="line">    public function showCartList()</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        session_start();</span><br><span class="line"></span><br><span class="line">        $sessId = session_id();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        $key = &apos;cart:ids:set:&apos;.session_id();</span><br><span class="line"></span><br><span class="line">        //先根据集合拿到商品ID</span><br><span class="line">        $idArr =  $this-&gt;redis-&gt;sMembers($key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        for ($i=0; $i&lt;count($idArr); $i++) &#123;</span><br><span class="line"></span><br><span class="line">            $k  = &apos;cart:&apos;.session_id().&apos;:&apos;.$idArr[$i];//id </span><br><span class="line"></span><br><span class="line">            // echo $k,&apos;&lt;br/&gt;&apos;;</span><br><span class="line">            $list[] = $this-&gt;redis-&gt;hGetAll($k);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        include &apos;./View/show.php&apos;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function goodsData($gid)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        $goodsData = array(</span><br><span class="line"></span><br><span class="line">            1 =&gt; array(</span><br><span class="line">                &apos;id&apos; =&gt; 1,</span><br><span class="line">                &apos;gname&apos; =&gt; &apos;xxoo&apos;,</span><br><span class="line">                &apos;price&apos; =&gt; &apos;1.5&apos;</span><br><span class="line">            ),</span><br><span class="line"></span><br><span class="line">            2 =&gt; array(</span><br><span class="line">                &apos;id&apos; =&gt; 2,</span><br><span class="line">                &apos;gname&apos; =&gt; &apos;xxoo22&apos;,</span><br><span class="line">                &apos;price&apos; =&gt; &apos;221.5&apos;</span><br><span class="line">            ),</span><br><span class="line">            3 =&gt; array(</span><br><span class="line">                &apos;id&apos; =&gt; 3,</span><br><span class="line">                &apos;gname&apos; =&gt; &apos;xxoo33&apos;,</span><br><span class="line">                &apos;price&apos; =&gt; &apos;331.5&apos;</span><br><span class="line">            ),</span><br><span class="line">            4 =&gt; array(</span><br><span class="line">                &apos;id&apos; =&gt; 4,</span><br><span class="line">                &apos;gname&apos; =&gt; &apos;xxoo44&apos;,</span><br><span class="line">                &apos;price&apos; =&gt; &apos;4441.5&apos;</span><br><span class="line">            ),    </span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        return $goodsData[$gid];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/04/11/一段解决域名对应多ip访问的问题的办法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/11/一段解决域名对应多ip访问的问题的办法/" itemprop="url">一段解决域名对应多ip访问的问题的办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-11T21:05:00+08:00">
                2017-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一段解决域名对应多ip访问的问题的办法</p>
<p>PHP获取远程网页内容有多种方式，例如用自带的file_get_contents、fopen等函数。<br>引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">echo file_get_contents(&quot;http://demo56.com/demo.php&quot;);   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>　　但是，在DNS轮询等负载均衡中，同一域名，可能对应多台服务器，多个IP。假设demo56.com被DNS解析到72.249.146.213、72.249.146.214、72.249.146.215三个IP，用户每次访问demo56.com，系统会根据负载均衡的相应算法访问其中的一台服务器。</p>
<p>　　上周做一个视频项目时，就碰到这样一类需求：需要依次访问每台服务器上的一个PHP接口程序（假设为abc.php），查询这台服务器的传输状态。</p>
<p>　　这时就不能直接用file_get_contents访问demo56.com/abc.php了，因为它可能一直重复访问某一台服务器。</p>
<p>　　而采用依次访问<a href="http://72.249.146.213/abc.php%E3%80%81http://72.249.146.214/abc.php%E3%80%81http://72.249.146.215/abc.php%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E5%9C%A8%E8%BF%99%E4%B8%89%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84Web" target="_blank" rel="noopener">http://72.249.146.213/abc.php、http://72.249.146.214/abc.php、http://72.249.146.215/abc.php的方法，在这三台服务器上的Web</a> Server配有多个虚拟主机时，也是不行的。</p>
<p>　　通过设置本地hosts也不行，因为hosts不能设置多个IP对应同一个域名。</p>
<p>　　那就只有通过PHP和HTTP协议来实现：访问abc.php时，在header头中加上demo56.com域名。于是，我写了下面这个PHP函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">/************************ </span><br><span class="line">* 函数用途：同一域名对应多个IP时，获取指定服务器的远程网页内容 </span><br><span class="line">* 参数说明： </span><br><span class="line">*    $ip   服务器的IP地址 </span><br><span class="line">*    $host   服务器的host名称 </span><br><span class="line">*    $url   服务器的URL地址（不含域名） </span><br><span class="line">* 返回值： </span><br><span class="line">*    获取到的远程网页内容 </span><br><span class="line">*    false   访问远程网页失败 </span><br><span class="line">************************/  </span><br><span class="line">function HttpVisit($ip, $host, $url)     </span><br><span class="line">&#123;     </span><br><span class="line">    $errstr = &apos;&apos;;     </span><br><span class="line">    $errno = &apos;&apos;;  </span><br><span class="line">    $fp = fsockopen ($ip, 80, $errno, $errstr, 90);  </span><br><span class="line">    if (!$fp)     </span><br><span class="line">    &#123;     </span><br><span class="line">         return false;     </span><br><span class="line">    &#125;     </span><br><span class="line">    else    </span><br><span class="line">    &#123;     </span><br><span class="line">        $out = &quot;GET &#123;$url&#125; HTTP/1.1\r\n&quot;;  </span><br><span class="line">        $out .= &quot;Host:&#123;$host&#125;\r\n&quot;;     </span><br><span class="line">        $out .= &quot;Connection: close\r\n\r\n&quot;;  </span><br><span class="line">        fputs ($fp, $out);     </span><br><span class="line">  </span><br><span class="line">        while($line = fread($fp, 4096))&#123;  </span><br><span class="line">           $response .= $line;  </span><br><span class="line">        &#125;  </span><br><span class="line">        fclose( $fp );  </span><br><span class="line">  </span><br><span class="line">        //去掉Header头信息  </span><br><span class="line">        $pos = strpos($response, &quot;\r\n\r\n&quot;);  </span><br><span class="line">        $response = substr($response, $pos + 4);  </span><br><span class="line">      </span><br><span class="line">        return $response;     </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">//调用方法：  </span><br><span class="line">$server_info1 = HttpVisit(&quot;72.249.146.213&quot;, &quot;demo56.com&quot;, &quot;/abc.php&quot;);  </span><br><span class="line">$server_info2 = HttpVisit(&quot;72.249.146.214&quot;, &quot;demo56.com&quot;, &quot;/abc.php&quot;);  </span><br><span class="line">$server_info3 = HttpVisit(&quot;72.249.146.215&quot;, &quot;demo56.com&quot;, &quot;/abc.php&quot;);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/03/17/抓取百度搜索页面的PHP代码示例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/17/抓取百度搜索页面的PHP代码示例/" itemprop="url">抓取百度搜索页面的PHP代码示例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-17T19:05:00+08:00">
                2017-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>分享一段很使用的代码</p>
<p>给出一段PHP多线程、与For循环，抓取百度搜索页面的PHP代码示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">  class test_thread_run extends Thread   </span><br><span class="line">  &#123;  </span><br><span class="line">      public $url;  </span><br><span class="line">      public $data;  </span><br><span class="line">  </span><br><span class="line">      public function __construct($url)  </span><br><span class="line">      &#123;  </span><br><span class="line">          $this-&gt;url = $url;  </span><br><span class="line">      &#125;  </span><br><span class="line">  </span><br><span class="line">      public function run()  </span><br><span class="line">      &#123;  </span><br><span class="line">          if(($url = $this-&gt;url))  </span><br><span class="line">          &#123;  </span><br><span class="line">              $this-&gt;data = model_http_curl_get($url);  </span><br><span class="line">          &#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  function model_thread_result_get($urls_array)   </span><br><span class="line">  &#123;  </span><br><span class="line">      foreach ($urls_array as $key =&gt; $value)   </span><br><span class="line">      &#123;  </span><br><span class="line">          $thread_array[$key] = new test_thread_run($value[&quot;url&quot;]);  </span><br><span class="line">          $thread_array[$key]-&gt;start();  </span><br><span class="line">      &#125;  </span><br><span class="line">  </span><br><span class="line">      foreach ($thread_array as $thread_array_key =&gt; $thread_array_value)   </span><br><span class="line">      &#123;  </span><br><span class="line">          while($thread_array[$thread_array_key]-&gt;isRunning())  </span><br><span class="line">          &#123;  </span><br><span class="line">              usleep(10);  </span><br><span class="line">          &#125;  </span><br><span class="line">          if($thread_array[$thread_array_key]-&gt;join())  </span><br><span class="line">          &#123;  </span><br><span class="line">              $variable_data[$thread_array_key] = $thread_array[$thread_array_key]-&gt;data;  </span><br><span class="line">          &#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">      return $variable_data;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  function model_http_curl_get($url,$userAgent=&quot;&quot;)   </span><br><span class="line">  &#123;  </span><br><span class="line">      $userAgent = $userAgent ? $userAgent : &apos;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.2)&apos;;   </span><br><span class="line">      $curl = curl_init();  </span><br><span class="line">      curl_setopt($curl, CURLOPT_URL, $url);  </span><br><span class="line">      curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);  </span><br><span class="line">      curl_setopt($curl, CURLOPT_TIMEOUT, 5);  </span><br><span class="line">      curl_setopt($curl, CURLOPT_USERAGENT, $userAgent);  </span><br><span class="line">      $result = curl_exec($curl);  </span><br><span class="line">      curl_close($curl);  </span><br><span class="line">      return $result;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  for ($i=0; $i &lt; 100; $i++)   </span><br><span class="line">  &#123;   </span><br><span class="line">      $urls_array[] = array(&quot;name&quot; =&gt; &quot;baidu&quot;, &quot;url&quot; =&gt; &quot;http://www.baidu.com/s?wd=&quot;.mt_rand(10000,20000));  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  $t = microtime(true);  </span><br><span class="line">  $result = model_thread_result_get($urls_array);  </span><br><span class="line">  $e = microtime(true);  </span><br><span class="line">  echo &quot;多线程：&quot;.($e-$t).&quot;\n&quot;;  </span><br><span class="line">  </span><br><span class="line">  $t = microtime(true);  </span><br><span class="line">  foreach ($urls_array as $key =&gt; $value)   </span><br><span class="line">  &#123;  </span><br><span class="line">      $result_new[$key] = model_http_curl_get($value[&quot;url&quot;]);  </span><br><span class="line">  &#125;  </span><br><span class="line">  $e = microtime(true);  </span><br><span class="line">  echo &quot;For循环：&quot;.($e-$t).&quot;\n&quot;;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/02/21/mysql的cardinality异常，导致索引不可用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/21/mysql的cardinality异常，导致索引不可用/" itemprop="url">mysql的cardinality异常，导致索引不可用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-21T09:05:00+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前段时间，一大早上，就收到报警，警告php-fpm进程的数量超过阈值。最终发现是一条sql没用到索引，导致执行数据库查询慢了，最终导致php-fpm进程数增加。最终通过analyze table feed_comment_info_id_0000 命令更新了Cardinality ，才能再次用到索引。<br><strong>排查过程如下：</strong><br>sql语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from feed_comment_info_id_0000 where obj_id=101 and type=1;</span><br></pre></td></tr></table></figure>
<p>索引信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">show index from feed_comment_info_id_0000</span><br><span class="line">+---------------------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+</span><br><span class="line">| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment |</span><br><span class="line">+---------------------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+</span><br><span class="line">| feed_comment_info_id_0000 | 0 | PRIMARY  | 1 | id      | A | 6216 | NULL | NULL |     | BTREE | | </span><br><span class="line">| feed_comment_info_id_0000 | 1 | obj_type | 1 | obj_id  | A | 6216 | NULL | NULL |     | BTREE | | </span><br><span class="line">| feed_comment_info_id_0000 | 1 | obj_type | 2 | type    | A | 6216 | NULL | NULL | YES | BTREE | | </span><br><span class="line">| feed_comment_info_id_0000 | 1 | user_id  | 1 | user_id | A | 6216 | NULL | NULL |     | BTREE | | </span><br><span class="line">+---------------------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>通过explian查看时，发现sql用的是主键PRIMARY，而不是obj_type索引。通过show index 查看索引的Cardinality值，发现这个值是实际数据的两倍。感觉这个Cardinality值已经不正常，因此通过analyzea table命令对这个值从新进行了计算。命令执行完毕后，就可用使用索引了。</p>
<p><strong>Cardinality解释</strong><br>官方文档的解释：<br>An estimate of the number of unique values in the index. This is updated by running ANALYZE TABLE or myisamchk -a. Cardinality is counted based on statistics stored as integers, so the value is not necessarily exact even for small tables. The higher the cardinality, the greater the chance that MySQL uses the index when doing<br>总结一下：<br>1、它代表的是索引中唯一值的数目的估计值。如果是myisam引擎，这个值是一个准确的值。如果是innodb引擎，这个值是一个估算的值，每次执行show index 时，可能会不一样<br>2、创建Index时（primary key除外），MyISAM的表Cardinality的值为null，InnoDB的表Cardinality的值大概为行数；<br>3、值的大小会影响到索引的选择<br>4、创建Index时，MyISAM的表Cardinality的值为null，InnoDB的表Cardinality的值大概为行数。<br>5、可以通过Analyze table来更新一张表或者mysqlcheck -Aa来进行更新整个数据库<br>6、可以通过 show index 查看其值</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2017/02/01/PHP返回内容过长时被nginx截断的解决办法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/01/PHP返回内容过长时被nginx截断的解决办法/" itemprop="url">PHP返回内容过长时被nginx截断的解决办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-01T17:05:00+08:00">
                2017-02-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>查看了html源代码，发现html源代码被截断了。因此，导致网页内容显示不全。<br>之后的整个分析过程绕了一大圈，即是tcpdump，又是用tcpflow进行网络包分析。最后，还是从nginx的错误日志中发现了端倪。<br>在nginx的错误日志中发现如下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016/03/29 06:08:10 [crit] 7042#0: *3 open() &quot;/var/lib/nginx/tmp/fastcgi/4/00/0000000004&quot; failed (13: Permission denied) while reading upstream, client: 117.72.224.240, server: www.bo56.com, request: &quot;GET /wp-admin/post-new.php HTTP/1.1&quot;, upstream: &quot;fastcgi://127.0.0.1:9010&quot;, host: &quot;www.bo56.com&quot;, referrer: &quot;http://www.bo56.com/wp-admin/edit.php&quot;</span><br></pre></td></tr></table></figure>
<p>错误日志显示， Permission denied，说明没权限。把这个目录设置为 775 权限问题解决。网页也就正常显示了。<br>如果PHP返回的内容过大，nginx会把一部分内容先存到文本文件中，等全部内容都接收完毕后，再一并发送到客户端。</p>
<p>在使用tcpdump抓包分析的时候，发现nginx进程主动向PHP进程发送了reset标识，终止通信。可能，nginx发现权限有问题，就关闭了连接。只是猜测，没有验证。图如下：</p>
<p><a href="http://www.bo56.com/wp-content/uploads/2016/03/tcpdump_reset2.png" target="_blank" rel="noopener"><img src="http://www.bo56.com/wp-content/uploads/2016/03/tcpdump_reset2.png" alt="tcpdump_reset2"></a></p>
<p><a href="http://www.bo56.com/%E8%B0%83%E8%AF%95%E5%88%A9%E5%99%A8%E4%B9%8Btcpdump/" target="_blank" rel="noopener">使用tcpdump抓包教程</a></p>
<h2 id="经验教训"><a href="#经验教训" class="headerlink" title="经验教训"></a>经验教训</h2><p>这次算是一次比较失败的问题排查。本来可以几分钟解决的事情，却花费了很长的时间。<br>切记，遇到问题，不要盲目的不断尝试。首先，要看日志查找线索。利用掌握的知识合理的推理分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/12/05/代码的分享/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/05/代码的分享/" itemprop="url">代码的分享</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-05T18:11:00+08:00">
                2016-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当PHP截取中英文混合字符串时，最后一个汉字经常被拆成两半，例：截取字符串的前18个字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php  </span><br><span class="line">$text = &quot;1欢迎访问blog我的播客&quot;;  </span><br><span class="line">$value = substr($text, 0, 18);  </span><br><span class="line">echo $value.&quot;&lt;BR&gt;&quot;;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>输出为结果为：1欢迎访问blog我的?BR&gt;</p>
<p>于是写了以下这段代码，判断如果中英文混合字符串中的汉字字节数为奇数，则少截取一个字节，保证汉字显示完整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$text = &quot;1欢迎访问blog我的播客&quot;;  </span><br><span class="line">$value = substr($text, 0, 18);  </span><br><span class="line">$value_length = strlen($value);     </span><br><span class="line">$value_count = 0;     </span><br><span class="line">for ($i = 0; $i &lt; $value_length; $i++)     </span><br><span class="line">&#123;     </span><br><span class="line">    if (ord($value&#123;$i&#125;) &gt; 127)     </span><br><span class="line">    &#123;     </span><br><span class="line">        $value_count++;     </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;     </span><br><span class="line">if ($value_count % 2 != 0)     </span><br><span class="line">&#123;     </span><br><span class="line">    $value = substr($text, 0, $value_length - 1);   </span><br><span class="line">&#125;  </span><br><span class="line">echo $value.&quot;&lt;BR&gt;&quot;;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>输出为结果为：1欢迎访问blog我的</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/11/07/mysql索引合并,一条sql可以使用多个索引/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/07/mysql索引合并,一条sql可以使用多个索引/" itemprop="url">mysql索引合并,一条sql可以使用多个索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-07T18:11:00+08:00">
                2016-11-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mysql的索引合并并不是什么新特性。早在mysql5.0版本就已经实现。之所以还写这篇博文，是因为好多人还一直保留着一条sql语句只能使用一个索引的错误观念。本文会通过一些示例来说明如何使用索引合并。</p>
<h5 id="什么是索引合并"><a href="#什么是索引合并" class="headerlink" title="什么是索引合并"></a>什么是索引合并</h5><p>下面我们看下mysql文档中对索引合并的说明：<br>The Index Merge method is used to retrieve rows with several range scans and to merge their results into one. The merge can produce unions, intersections, or unions-of-intersections of its underlying scans. This access method merges index scans from a single table; it does not merge scans across multiple tables.<br>根据官方文档中的说明，我们可以了解到：<br>1、索引合并是把几个索引的范围扫描合并成一个索引。<br>2、索引合并的时候，会对索引进行并集，交集或者先交集再并集操作，以便合并成一个索引。<br>3、这些需要合并的索引只能是一个表的。不能对多表进行索引合并。</p>
<h5 id="使用索引合并有啥收益"><a href="#使用索引合并有啥收益" class="headerlink" title="使用索引合并有啥收益"></a>使用索引合并有啥收益</h5><p>简单的说，索引合并，让一条sql可以使用多个索引。对这些索引取交集，并集，或者先取交集再取并集。从而减少从数据表中取数据的次数，提高查询效率。</p>
<h5 id="怎么确定使用了索引合并"><a href="#怎么确定使用了索引合并" class="headerlink" title="怎么确定使用了索引合并"></a>怎么确定使用了索引合并</h5><p>在使用explain对sql语句进行操作时，如果使用了索引合并，那么在输出内容的type列会显示 index_merge，key列会显示出所有使用的索引。如下：<br><a href="http://www.bo56.com/wp-content/uploads/2015/06/index_merge_sql.png" target="_blank" rel="noopener"><img src="http://www.bo56.com/wp-content/uploads/2015/06/index_merge_sql.png" alt="index_merge_sql"></a></p>
<p>在explain的extra字段中会以下几种：<br>Using union 索引取并集<br>Using sort_union 先对取出的数据按rowid排序，然后再取并集<br>Using intersect 索引取交集</p>
<p>你会发现并没有 sort_intersect，因为根据目前的实现，想索引取交集，必须保证通过索引取出的数据顺序和rowid顺序是一致的。所以，也就没必要sort了。</p>
<h5 id="sort-union索引合并的示例"><a href="#sort-union索引合并的示例" class="headerlink" title="sort_union索引合并的示例"></a>sort_union索引合并的示例</h5><h3 id="数据表结构"><a href="#数据表结构" class="headerlink" title="数据表结构"></a>数据表结构</h3><h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><h3 id="使用索引合并的案例"><a href="#使用索引合并的案例" class="headerlink" title="使用索引合并的案例"></a>使用索引合并的案例</h3><h3 id="未使用索引合并的案例"><a href="#未使用索引合并的案例" class="headerlink" title="未使用索引合并的案例"></a>未使用索引合并的案例</h3><h3 id="sort-union总结"><a href="#sort-union总结" class="headerlink" title="sort_union总结"></a>sort_union总结</h3><p>从上面的两个案例大家可以发现，相同模式的sql语句，可能有时能使用索引，有时不能使用索引。是否能使用索引，取决于mysql查询优化器对统计数据分析后，是否认为使用索引更快。<br>因此，单纯的讨论一条sql是否可以使用索引有点片面，还需要考虑数据。</p>
<h5 id="union索引合并使用案例"><a href="#union索引合并使用案例" class="headerlink" title="union索引合并使用案例"></a>union索引合并使用案例</h5><h3 id="数据表结构-1"><a href="#数据表结构-1" class="headerlink" title="数据表结构"></a>数据表结构</h3><p>数据结构和之前有所调整。主要调整有如下两方面：<br>1、引擎从myisam改为了innodb。<br>2、组合索引中增加了id，并把id放在最后。</p>
<h3 id="数据-1"><a href="#数据-1" class="headerlink" title="数据"></a>数据</h3><p>数据和上面的数据一样。</p>
<h3 id="使用索引合并的案例-1"><a href="#使用索引合并的案例-1" class="headerlink" title="使用索引合并的案例"></a>使用索引合并的案例</h3><h3 id="union总结"><a href="#union总结" class="headerlink" title="union总结"></a>union总结</h3><p>相同的数据，相同的sql语句，只是数据表结构有所调整，就从sort_union变为了union。有以下几个原因：<br>1、只要通过索引取出的数据已经按rowid进行了排序，就可以使用union。<br>2、组合索引中在最后加id字段，目的就是通过索引前两个字段取出的数据是按id排序。<br>3、把引擎从myisam改为innodb，目的就是让id和rowid的顺序一致。</p>
<h5 id="intersect使用案例"><a href="#intersect使用案例" class="headerlink" title="intersect使用案例"></a>intersect使用案例</h5><p>数据结构和数据和union案例中的一致。</p>
<h3 id="使用索引合并的案例-2"><a href="#使用索引合并的案例-2" class="headerlink" title="使用索引合并的案例"></a>使用索引合并的案例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test where (key1_part1=1 and key1_part2=1) and (key2_part1=1 and key2_part2=1)\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: test</span><br><span class="line">         type: index_merge</span><br><span class="line">possible_keys: key1,key2</span><br><span class="line">          key: key2,key1</span><br><span class="line">      key_len: 8,8</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 3</span><br><span class="line">        Extra: Using intersect(key2,key1); Using where; Using index</span><br><span class="line">1 row in set (0.02 sec)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gityuanye.cn/2016/10/10/注意sql语句中的通配符，别掉坑里面!/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lao Yuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/image/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lao Yuan's Personal Website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/10/注意sql语句中的通配符，别掉坑里面!/" itemprop="url">注意sql语句中的通配符，别掉坑里面!</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-10T10:21:00+08:00">
                2016-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>现象：</strong><br>有一个表 action_conf，数据如下：<br><a href="http://www.bo56.com/wp-content/uploads/2014/09/table.jpg" target="_blank" rel="noopener"><img src="http://www.bo56.com/wp-content/uploads/2014/09/table.jpg" alt="table"></a></p>
<p>如果想获取以<strong>exp_site10</strong>开头的en_name的记录，sql语句该如何写？<br>so easy！</p>
<p>很自信的在idb中执行了这条sql，就会发现结果并不是所预期的。<br>你会发现，执行上面的sql会把所有以 <strong>exp_site_10</strong>开头的记录都列出来了。</p>
<p><strong>原因：</strong><br>其实，这都是sql中的通配符在作怪。在sql中，下划线_是一个通配符，能匹配任何单一字符。<br>既然直到原因，修改sql就很容易了。正确的sql应该是：</p>
<p>在通配符前面增加转移字符后，mysql就会把通配符视为普通字符。</p>
<p><strong>进阶：</strong><br>通配符整理：<br>通配符 说明<br>% 替代一个或多个字符<br>_ 仅替代一个字符<br>[charlist] 字符列中的任何单一字符<br>[^charlist]或[!charlist] 不在字符列中的任何单一字符</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/upload/image/avatar.jpg"
                alt="Lao Yuan" />
            
              <p class="site-author-name" itemprop="name">Lao Yuan</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lao Yuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
